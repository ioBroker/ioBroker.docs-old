<!DOCTYPE html>
<!--[if IE 8 ]>
	<html class="no-js ie8" lang="en-GB">
<![endif]-->
<!--[if IE 9 ]>
	<html class="no-js ie9" lang="en-GB">
<![endif]-->
<!--[if gt IE 9]><!-->
<html lang="en-GB"><!--<![endif]-->
	<head>
				<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE"> 

		<link rel="profile" href="http://gmpg.org/xfn/11">
		<link rel="pingback" href="http://www.iobroker.net/docu/xmlrpc.php">
		
		<title>Adapter MQTT &#8211; ioBroker</title>
<link rel='dns-prefetch' href='//netdna.bootstrapcdn.com'>
<link rel='dns-prefetch' href='//s.w.org'>
<link rel="alternate" type="application/rss+xml" title="ioBroker &raquo; Feed" href="index-2.rss?feed=rss2&#038;lang=en">
<link rel="alternate" type="application/rss+xml" title="ioBroker &raquo; Comments Feed" href="index-3.rss?feed=comments-rss2&#038;lang=en">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.iobroker.net\/docu\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.5"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='crayon-css' href='wp-content\plugins\crayon-syntax-highlighter\css\min\crayon.min.css?ver=_2.7.2_beta' type='text/css' media='all'>
<link rel='stylesheet' id='crayon-theme-classic-css' href='wp-content\plugins\crayon-syntax-highlighter\themes\classic\classic.css?ver=_2.7.2_beta' type='text/css' media='all'>
<link rel='stylesheet' id='crayon-font-monaco-css' href='wp-content\plugins\crayon-syntax-highlighter\fonts\monaco.css?ver=_2.7.2_beta' type='text/css' media='all'>
<link rel='stylesheet' id='contact-form-7-css' href='wp-content\plugins\contact-form-7\includes\css\styles.css?ver=4.9.2' type='text/css' media='all'>
<link rel='stylesheet' id='cookie-law-info-css' href='wp-content\plugins\cookie-law-info\public\css\cookie-law-info-public.css?ver=1.7.6' type='text/css' media='all'>
<link rel='stylesheet' id='cookie-law-info-gdpr-css' href='wp-content\plugins\cookie-law-info\public\css\cookie-law-info-gdpr.css?ver=1.7.6' type='text/css' media='all'>
<link rel='stylesheet' id='dedo-css-css' href='wp-content\plugins\delightful-downloads\assets\css\delightful-downloads.min.css?ver=1.6.6' type='text/css' media='all'>
<link rel='stylesheet' id='mbpro-font-awesome-css' href='wp-content\plugins\maxbuttons\assets\libraries\font-awesome\css\font-awesome.min.css?ver=6.28' type='text/css' media='all'>
<link rel='stylesheet' id='page-list-style-css' href='wp-content\plugins\page-list\css\page-list.css?ver=5.1' type='text/css' media='all'>
<link rel='stylesheet' id='pc_google_analytics-frontend-css' href='http://www.iobroker.net/docu/wp-content/plugins/pc-google-analytics/assets/css/frontend.css?ver=1.0.0' type='text/css' media='all'>
<link rel='stylesheet' id='font-awesome-css' href='//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css' type='text/css' media='screen'>
<link rel='stylesheet' id='toc-screen-css' href='wp-content\plugins\table-of-contents-plus\screen.min.css?ver=1509' type='text/css' media='all'>
<link rel='stylesheet' id='parent-style-css' href='wp-content\themes\responsive-mobile\style.css?ver=4.7.5' type='text/css' media='all'>
<link rel='stylesheet' id='responsive-mobile-style-css' href='wp-content\themes\responsive-mobile\css\style.css?ver=1.8' type='text/css' media='all'>
<link rel='stylesheet' id='responsive-mobile-child-style-css' href='wp-content\themes\responsive-mobile_child\style.css?ver=1.0' type='text/css' media='all'>
<link rel='stylesheet' id='recent-posts-widget-with-thumbnails-public-style-css' href='wp-content\plugins\recent-posts-widget-with-thumbnails\public.css?ver=6.5.0' type='text/css' media='all'>
<link rel='stylesheet' id='cleverness_todo_list_frontend-css' href='wp-content\plugins\cleverness-to-do-list\css\cleverness-to-do-list-frontend.css?ver=3.4.2' type='text/css' media='all'>
<link rel='stylesheet' id='jquery.ui.theme-css' href='wp-content\plugins\cleverness-to-do-list\css\jquery-ui-fresh.css?ver=3.4.2' type='text/css' media='all'>
<link rel='stylesheet' id='tablepress-default-css' href='wp-content\tablepress-combined.min.css?ver=128' type='text/css' media='all'>
<link rel='stylesheet' id='bootstrap-css' href='wp-content\themes\responsive-mobile\libraries\bootstrap\css\bootstrap.min.css?ver=4.7.5' type='text/css' media='all'>
<script type='text/javascript' src='wp-includes\js\jquery\jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='wp-includes\js\jquery\jquery-migrate.min.js?ver=1.4.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"http:\/\/www.iobroker.net\/docu\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='wp-content\plugins\crayon-syntax-highlighter\js\min\crayon.min.js?ver=_2.7.2_beta'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var Cli_Data = {"nn_cookie_ids":[],"cookielist":[]};
var log_object = {"ajax_url":"http:\/\/www.iobroker.net\/docu\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='wp-content\plugins\cookie-law-info\public\js\cookie-law-info-public.js?ver=1.7.6'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var mb_ajax = {"ajaxurl":"http:\/\/www.iobroker.net\/docu\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='wp-content\plugins\maxbuttons\js\min\front.js?ver=6.28'></script>
<script type='text/javascript' src='wp-content\plugins\pc-google-analytics\assets\js\frontend.min.js?ver=1.0.0'></script>
<script type='text/javascript' src='wp-content\themes\responsive-mobile\libraries\bootstrap\js\bootstrap.min.js?ver=4.7.5'></script>
<link rel='https://api.w.org/' href='index.json?rest_route=/'>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.xml?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="wp-includes\wlwmanifest.xml"> 
<meta name="generator" content="WordPress 4.7.5">
<link rel="canonical" href="index-88.htm?page_id=6435&#038;lang=en">
<link rel='shortlink' href='http://www.iobroker.net/docu/?p=6435'>
<link rel="alternate" type="application/json+oembed" href="index-86.json?rest_route=%2Foembed%2F1.0%2Fembed&#038;url=http%3A%2F%2Fwww.iobroker.net%2Fdocu%2F%3Fpage_id%3D6435%26lang%3Den">
<link rel="alternate" type="text/xml+oembed" href="index-85.xml?rest_route=%2Foembed%2F1.0%2Fembed&#038;url=http%3A%2F%2Fwww.iobroker.net%2Fdocu%2F%3Fpage_id%3D6435%26lang%3Den&#038;format=xml">
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		
		ga('create', 'UA-86900958-1', 'auto');
		ga('send', 'pageview');
		
		</script>

<style>
.scroll-back-to-top-wrapper {
    position: fixed;
	opacity: 0;
	visibility: hidden;
	overflow: hidden;
	text-align: center;
	z-index: 99999999;
    background-color: #777777;
	color: #eeeeee;
	width: 50px;
	height: 48px;
	line-height: 48px;
	right: 30px;
	bottom: 30px;
	padding-top: 2px;
	border-top-left-radius: 10px;
	border-top-right-radius: 10px;
	border-bottom-right-radius: 10px;
	border-bottom-left-radius: 10px;
	-webkit-transition: all 0.5s ease-in-out;
	-moz-transition: all 0.5s ease-in-out;
	-ms-transition: all 0.5s ease-in-out;
	-o-transition: all 0.5s ease-in-out;
	transition: all 0.5s ease-in-out;
}
.scroll-back-to-top-wrapper:hover {
	background-color: #888888;
  color: #eeeeee;
}
.scroll-back-to-top-wrapper.show {
    visibility:visible;
    cursor:pointer;
	opacity: 1.0;
}
.scroll-back-to-top-wrapper i.fa {
	line-height: inherit;
}
.scroll-back-to-top-wrapper .fa-lg {
	vertical-align: 0;
}
</style><!-- Analytics by WP-Statistics v12.6 - https://wp-statistics.com/ -->
<link rel="alternate" href="index-378.htm?page_id=3790&#038;lang=de" hreflang="de">
<link rel="alternate" href="index-88.htm?page_id=6435&#038;lang=en" hreflang="en">
<link rel="alternate" href="index-141.htm?page_id=4643&#038;lang=ru" hreflang="ru">
		<script type="text/javascript">
			var cli_flush_cache=1;
		</script>
				<style type="text/css" id="wp-custom-css">
			/*
You can add your own CSS here.

Click the help icon above to learn more.
*/
.site-content .content-area{
	/*background: #6592c9;*/
}		</style>
	<style type="text/css">
.paypal-donations { text-align: center !important }
</style>
	</head>

<body class="page-template page-template-page-templates page-template-content-sidebar-page_adaptermenue page-template-page-templatescontent-sidebar-page_adaptermenue-php page page-id-6435 page-child parent-pageid-5298 group-blog content-sidebar-page_adaptermenue" itemscope="itemscope" itemtype="http://schema.org/WebPage">
<div id="container" class="site">
	<a class="skip-link screen-reader-text" href="#content">Skip to content</a>
	<a class="skip-link screen-reader-text" href="#main-navigation">Skip to main menu</a>
	<div id="top-menu-container" class="container-full-width">
		<nav id="top-menu" class="container" itemscope="" itemtype="http://schema.org/SiteNavigationElement">
			<ul id="menu-2016_top_menue" class="top-menu"><li id="menu-item-2203-de" class="lang-item lang-item-4 lang-item-de lang-item-first menu-item menu-item-type-custom menu-item-object-custom menu-item-2203-de"><a href="index-378.htm?page_id=3790&#038;lang=de" hreflang="de-DE" lang="de-DE">Deutsch</a></li>
<li id="menu-item-2203-en" class="lang-item lang-item-7 lang-item-en current-lang menu-item menu-item-type-custom menu-item-object-custom menu-item-2203-en"><a href="index-88.htm?page_id=6435&#038;lang=en" hreflang="en-GB" lang="en-GB">English</a></li>
<li id="menu-item-2203-ru" class="lang-item lang-item-20 lang-item-ru menu-item menu-item-type-custom menu-item-object-custom menu-item-2203-ru"><a href="index-141.htm?page_id=4643&#038;lang=ru" hreflang="ru-RU" lang="ru-RU">Русский</a></li>
</ul>		</nav>
	</div><!-- top menu container -->
        <div id="header_section">
	<header id="header" class="container-full-width site-header" role="banner" itemscope="itemscope" itemtype="http://schema.org/WPHeader">
				<div class="container">
			<div class="header-row">
				<div id="site-branding">
							<div id="logo">
			<a href="index-1.htm?lang=en" rel="home" itemprop="url" title="ioBroker">
				<img src="wp-content\uploads\ioBroker_logo_lang-e1456684383484.png" alt="ioBroker" itemprop="image">
			</a>
		</div>
					</div>
				<div id="secondary-header">
					
	<div id="top-widget" class="top-widget" role="complementary" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
		
			<div id="search-2" class="responsive-mobile-top-widget widget_search"><form role="search" method="get" class="search-form" action="http://www.iobroker.net/docu/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s">
				</label>
				<input type="submit" class="search-submit" value="Search">
			<input type="hidden" name="lang" value="en"></form></div>
			</div><!-- end of #top-widget -->
				</div>
			</div>
		</div>

			</header><!-- #header -->

	<div id="main-menu-container" class="container-full-width">
		<div id="main-menu" class="container">
			<nav id="main-navigation" class="site-navigation" role="navigation" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
				<div id="mobile-current-item">Menu</div>
				<button id="mobile-nav-button"><span class="accessibile-label">Mobile menu toggle</span></button>
				<div class="main-nav"><ul id="menu-2016_kopfzeile_en" class="menu"><li id="menu-item-2685" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-2685"><a href="..\index-2.htm?lang=en">Start page</a></li>
<li id="menu-item-2680" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2680"><a href="index-66.htm?page_id=2620&#038;lang=en">News</a></li>
<li id="menu-item-2634" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2634"><a href="index-67.htm?page_id=2632&#038;lang=en">Installation</a>
<ul class="sub-menu">
	<li id="menu-item-5098" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5098"><a href="index-68.htm?page_id=5090&#038;lang=en">Raspberry (JESSIE) – fast install</a></li>
	<li id="menu-item-5121" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5121"><a href="index-69.htm?page_id=5111&#038;lang=en">Pine64 (JESSIE) – fast install</a></li>
	<li id="menu-item-4922" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4922"><a href="index-70.htm?page_id=4919&#038;lang=en">Video</a></li>
	<li id="menu-item-5351" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5351"><a href="index-71.htm?page_id=5347&#038;lang=en">How to install node.js on linux</a></li>
	<li id="menu-item-5647" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5647"><a href="index-72.htm?page_id=5639&#038;lang=en">Shot instruction for Debian</a></li>
	<li id="menu-item-5805" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5805"><a href="index-73.htm?page_id=5799&#038;lang=en">Install node.js on PogoPlug</a></li>
</ul>
</li>
<li id="menu-item-2681" class="menu-item menu-item-type-post_type menu-item-object-page current-page-ancestor current-menu-ancestor current_page_ancestor menu-item-has-children menu-item-2681"><a href="index-74.htm?page_id=2573&#038;lang=en">Adapters</a>
<ul class="sub-menu">
	<li id="menu-item-4549" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-4549"><a href="index-75.htm?page_id=4541&#038;lang=en">Common</a>
	<ul class="sub-menu">
		<li id="menu-item-4198" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4198"><a href="index-76.htm?page_id=4179&#038;lang=en">Driver Admin</a></li>
	</ul>
</li>
	<li id="menu-item-4792" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-4792"><a href="index-77.htm?page_id=4787&#038;lang=en">Media</a>
	<ul class="sub-menu">
		<li id="menu-item-4795" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4795"><a href="index-78.htm?page_id=4713&#038;lang=en">Adapter sayIt</a></li>
	</ul>
</li>
	<li id="menu-item-4793" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-4793"><a href="index-79.htm?page_id=4784&#038;lang=en">Scripts and logic</a>
	<ul class="sub-menu">
		<li id="menu-item-4794" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4794"><a href="index-80.htm?page_id=4711&#038;lang=en">Adapter text2command</a></li>
		<li id="menu-item-6775" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6775"><a href="index-81.htm?page_id=5809&#038;lang=en">Javascript</a></li>
	</ul>
</li>
	<li id="menu-item-4550" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-4550"><a href="index-82.htm?page_id=4538&#038;lang=en">Storage</a>
	<ul class="sub-menu">
		<li id="menu-item-4551" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4551"><a href="index-83.htm?page_id=4531&#038;lang=en">Adapter History</a></li>
		<li id="menu-item-5297" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5297"><a href="index-84.htm?page_id=5289&#038;lang=en">Adapter Pushsafer</a></li>
		<li id="menu-item-4197" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4197"><a href="index-85.htm?page_id=4184&#038;lang=en">Adapter SQL</a></li>
	</ul>
</li>
	<li id="menu-item-5300" class="menu-item menu-item-type-post_type menu-item-object-page current-page-ancestor current-menu-ancestor current-menu-parent current-page-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-5300"><a href="index-86.htm?page_id=5298&#038;lang=en">Communication</a>
	<ul class="sub-menu">
		<li id="menu-item-5301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5301"><a href="index-84.htm?page_id=5289&#038;lang=en">Adapter Pushsafer</a></li>
		<li id="menu-item-6776" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6776"><a href="index-87.htm?page_id=6624&#038;lang=en">Adapter Telegram</a></li>
		<li id="menu-item-6777" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-6435 current_page_item menu-item-6777"><a href="index-88.htm?page_id=6435&#038;lang=en">Adapter MQTT</a></li>
	</ul>
</li>
	<li id="menu-item-6878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-6878"><a href="index-89.htm?page_id=2578&#038;lang=en">Hardware</a>
	<ul class="sub-menu">
		<li id="menu-item-6879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6879"><a href="index-90.htm?page_id=2575&#038;lang=en">Siemens SIMATIC S7</a></li>
		<li id="menu-item-6880" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6880"><a href="index-91.htm?page_id=4188&#038;lang=en">RFLink</a></li>
	</ul>
</li>
	<li id="menu-item-5043" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-5043"><a href="index-92.htm?page_id=5038&#038;lang=en">Adapter category VIS</a>
	<ul class="sub-menu">
		<li id="menu-item-5034" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5034"><a href="index-37.htm?page_id=5026&#038;lang=de">ioBroker.vis App</a></li>
	</ul>
</li>
	<li id="menu-item-5827" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-5827"><a href="index-93.htm?page_id=5823&#038;lang=en">Visualisation</a>
	<ul class="sub-menu">
		<li id="menu-item-5828" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5828"><a href="index-94.htm?page_id=5816&#038;lang=en">Adapter Flot</a></li>
	</ul>
</li>
</ul>
</li>
<li id="menu-item-2682" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2682"><a href="index-95.htm?page_id=2622&#038;lang=en">Downloads</a>
<ul class="sub-menu">
	<li id="menu-item-5145" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5145"><a href="index-96.htm?page_id=5139&#038;lang=en">Downloads for installation</a></li>
</ul>
</li>
<li id="menu-item-2683" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2683"><a href="index-97.htm?page_id=2676&#038;lang=en">Forum / Support</a>
<ul class="sub-menu">
	<li id="menu-item-3009" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-3009"><a href="http://forum.iobroker.net">Forum</a></li>
	<li id="menu-item-3987" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3987"><a href="index-98.htm?page_id=3971&#038;lang=de">Command line interface</a></li>
	<li id="menu-item-5103" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5103"><a href="index-99.htm?page_id=5100&#038;lang=en">ioBroker does not run any more</a></li>
</ul>
</li>
<li id="menu-item-2684" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2684"><a href="index-100.htm?page_id=2674&#038;lang=en">Development</a></li>
</ul></div>			</nav><!-- #site-navigation -->
		</div><!-- #main-menu -->
	</div><!-- #main-menu-container -->
	<div id="sub-menu-container" class="container-full-width">
		<div id="sub-menu" class="container">
			<nav id="sub-navigation" class="site-navigation" role="navigation" itemscope="itemscope" itemtype="http://schema.org/SiteNavigationElement">
						</nav><!-- #site-navigation -->
		</div><!-- #sub-menu -->
	</div><!-- #sub-menu-container -->
        </div>
	<div id="wrapper" class="site-content container-full-width">

	<div id="content" class="content-area">
		<main id="main" class="site-main content-sidebar" role="main">

			
				<div class="breadcrumb-list" xmlns:v="http://rdf.data-vocabulary.org/#"><span class="breadcrumb" typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="index-1.htm?lang=en">Home</a></span> <span class="chevron">&#8250;</span> <span class="breadcrumb" typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="index-379.htm?page_id=2366&lang=en">Englisch</a></span> <span class="chevron">&#8250;</span> <span class="breadcrumb" typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="index-74.htm?page_id=2573&lang=en">Adapter</a></span> <span class="chevron">&#8250;</span> <span class="breadcrumb" typeof="v:Breadcrumb"><a rel="v:url" property="v:title" href="index-86.htm?page_id=5298&lang=en">Communication</a></span> <span class="chevron">&#8250;</span> <span class="breadcrumb-current">Adapter MQTT</span></div>
								
					
<article id="post-6435" class="post-6435 page type-page status-publish hentry">
		
	
<header class="entry-header">
	<h1 class="entry-title post-title">Adapter MQTT</h1>
	</header><!-- .entry-header -->

	<div class="post-entry">
		<p><a href="https://github.com/ioBroker/ioBroker.mqtt"><img class="alignright" style="border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" width="149" height="149"></a><br>
<img class="alignnone" src="http://download.iobroker.net/img/logo-mqtt.png" width="64" height="64"></p>
<h2><span id="Description">Description</span></h2>
<p style="text-align: justify;"><a href="http://mqtt.org/">MQTT</a> (Message Queue Telemetry Transport) is a lightweight protocol used for communication between devices (M2M &#8211; machine-to-machine). It uses a model publisher-subscriber to send messages over TCP / IP protocol. The central part of the protocol is MQTT-server or broker who has access to the publisher and the subscriber. This protocol is very primitive: a short title, without integrity (that is why the transmission is implemented on top of TCP), does not impose any restrictions on the structure, coding or database schema. The only requirement for the data in each packet &#8211; they must be accompanied by the identifier information channel. This identifier specification called Topic Name.</p>
<p style="text-align: justify;">The MQTT Protocol requires a data broker. This is the Central idea of the technology. All devices send data only to the broker and receive data also from him only. After receiving the packet, the broker sends it to all devices on the network according to their subscription . For the device to get something from the broker it must subscribe to a topic. Topics arise dynamically upon subscription or upon arrival of the package with this topic. By subscribing to a topic, you can give up. Thus topics are a convenient mechanism for organizing different kinds of relationships: one-to-many, many-to-one and many-to-many.</p>
<p><strong>Important points:</strong></p>
<ul>
<li>the devices themselves establish communication with the broker, they may is behind a NAT and does not have static IP addresses,</li>
<li>you can use SSL to encrypt the traffic,</li>
<li>MQTT brokers allow you to connect to them through the WebSocket protocol on port 80,</li>
<li>different brokers may be interconnected by subscribing to messages from each other.</li>
</ul>
<div id="toc_container" class="no_bullets"><ul class="toc_list"><li><a href="#Description"><span class="toc_number toc_depth_1">1</span> Description</a></li><li><a href="#Information"><span class="toc_number toc_depth_1">2</span> Information</a></li><li><a href="#Installation"><span class="toc_number toc_depth_1">3</span> Installation</a></li><li><a href="#Setting"><span class="toc_number toc_depth_1">4</span> Setting</a><ul><li><a href="#IoBroker_working_as_MQTT-broker"><span class="toc_number toc_depth_2">4.1</span> IoBroker working as MQTT-broker</a></li><li><a href="#IoBroker_working_as_MQTT-client"><span class="toc_number toc_depth_2">4.2</span> IoBroker working as MQTT-client</a></li></ul></li><li><a href="#Application_8211_MQTT_gateway_protocols_8211_ModBus_RTU"><span class="toc_number toc_depth_1">5</span> Application &#8211; MQTT gateway protocols &#8211; ModBus RTU</a></li><li><a href="#Application_8211_connecting_mobile_clients"><span class="toc_number toc_depth_1">6</span> Application &#8211; connecting mobile clients</a></li><li><a href="#Application_8211_working_with_cloud_servers"><span class="toc_number toc_depth_1">7</span> Application &#8211; working with cloud servers</a></li></ul></div>

<h2><span id="Information">Information</span></h2>
<p>&nbsp;</p>
<table width="100%">
<tbody>
<tr>
<td style="width: 50%; height: 20px;"><strong>Current version<br>
</strong></td>
<td style="width: 50%; height: 20px;"><a href="https://www.npmjs.com/package/iobroker.mqtt"><img class="alignnone" src="http://img.shields.io/npm/v/iobroker.mqtt.svg" width="80" height="20"></a></td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>Necessary conditions</strong></td>
<td style="width: 50%; height: 20px;">/</td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>Developer</strong></td>
<td style="width: 50%; height: 20px;">Bluefox</td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>Keywords<br>
</strong></td>
<td style="width: 50%; height: 20px;">data transmission, sensors, cloud, publish/subscribe</td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>Github</strong></td>
<td style="width: 50%; height: 20px;"><img class="alignnone size-full wp-image-2342" src="wp-content\uploads\icon_link.png" alt="icon_link" width="16" height="16"> <a href="https://github.com/ioBroker/ioBroker.mqtt" target="_blank">Link</a></td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>Platform</strong></td>
<td style="width: 50%; height: 20px;">Javascript/Node.js</td>
</tr>
<tr>
<td style="width: 50%; height: 20px;"><strong>License</strong></td>
<td style="width: 50%; height: 20px;">MIT</td>
</tr>
</tbody>
</table>
<h2><span id="Installation"><span id="i-3">Installation</span></span></h2>
<p>Installation is on the <strong>Driver</strong> tab page of the <a href="index-76.htm?page_id=4179&amp;lang=en">administration system</a>. In the driver group <b>Network</b> find a line called <strong>MQTT Adapter</strong>, and press the button with the plus icon in the right side of the line.</p>
<p>&nbsp;</p>
<p><a href="wp-content\uploads\1.png"><img class="alignnone wp-image-6600 size-large" src="wp-content\uploads\1-1024x342.png" width="750" height="250" srcset="wp-content\uploads\1-1024x342.png 1024w, wp-content\uploads\1-150x50.png 150w, wp-content\uploads\1-300x100.png 300w, wp-content\uploads\1-100x33.png 100w, wp-content\uploads\1-200x67.png 200w, wp-content\uploads\1-450x150.png 450w, wp-content\uploads\1-600x201.png 600w, wp-content\uploads\1-900x301.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>You will see a pop-up window driver installation, after installation, it will automatically close.</p>
<p><a href="wp-content\uploads\2.png"><img class="alignnone wp-image-6602 size-medium" src="wp-content\uploads\2-300x153.png" width="300" height="153" srcset="wp-content\uploads\2-300x153.png 300w, wp-content\uploads\2-150x77.png 150w, wp-content\uploads\2-100x51.png 100w, wp-content\uploads\2-200x102.png 200w, wp-content\uploads\2-450x230.png 450w, wp-content\uploads\2-600x307.png 600w, wp-content\uploads\2-900x460.png 900w, wp-content\uploads\2.png 929w" sizes="(max-width: 300px) 100vw, 300px"></a></p>
<p>If all goes well, on the <strong>Settings driver</strong> tab appears <strong>mqtt.0</strong> installed instance of the driver.</p>
<p><a href="wp-content\uploads\3.png"><img class="alignnone wp-image-6603 size-medium" src="wp-content\uploads\3-300x156.png" width="300" height="156" srcset="wp-content\uploads\3-300x156.png 300w, wp-content\uploads\3-150x78.png 150w, wp-content\uploads\3-100x52.png 100w, wp-content\uploads\3-200x104.png 200w, wp-content\uploads\3-450x234.png 450w, wp-content\uploads\3-600x311.png 600w, wp-content\uploads\3.png 836w" sizes="(max-width: 300px) 100vw, 300px"></a></p>
<h2><span id="Setting"><span id="i-3">Setting</span></span></h2>
<p>As stated above, MQTT protocol implies a broker and clients. ioBroker server can act as a broker and a client. Setting to specify the operating mode &#8211; the type (server / broker or the customer / subscriber) Consider every option.</p>
<h3><span id="IoBroker_working_as_MQTT-broker">IoBroker working as MQTT-broker</span></h3>
<p>Basic settings if you intend to use the server/broker is shown in the picture:</p>
<p><a href="wp-content\uploads\4.png"><img class="alignnone wp-image-6604 size-medium" src="wp-content\uploads\4-282x300.png" width="282" height="300" srcset="wp-content\uploads\4-282x300.png 282w, wp-content\uploads\4-141x150.png 141w, wp-content\uploads\4-100x106.png 100w, wp-content\uploads\4-150x160.png 150w, wp-content\uploads\4-200x213.png 200w, wp-content\uploads\4-300x319.png 300w, wp-content\uploads\4-450x479.png 450w, wp-content\uploads\4-600x639.png 600w, wp-content\uploads\4.png 805w" sizes="(max-width: 282px) 100vw, 282px"></a></p>
<ul>
<li><strong>Use WebSockets</strong> &#8211; if there is a need to use WEB sockets for connection, you must install this option, with TCP-server will run in parallel with the WebSocket server,</li>
<li><strong>Port</strong> &#8211; the port to connect on TCP (default is 1883), a WebSocket server (see option above) runs on port +1 (default: 1884),</li>
<li><strong>SSL</strong> &#8211; this option is used if you want to encrypt all traffic (TCP or the WebSocket), thus it is necessary to specify certificates &#8211; simply select from a list of pre-set (specified in the system settings, see the <a href="index-76.htm?page_id=4179&amp;lang=en">systems management driver description</a>),</li>
<li><strong>authentication settings</strong> (username and password) &#8211; indicate, if necessary a specific user authentication, this setting is always used in conjunction with SSL-encryption option (not to transmit passwords in clear text over an insecure connection),</li>
<li><strong>Mask private values</strong> &#8211; the template (or several comma-separated) to filter variables ioBroker, which will be sent to the client, you can use special characters to specify a group of messages (for example, <code>memRSS, mqtt.0</code> &#8211; can be transmitted all the variables memory status of all drivers and all <strong>mqtt.0 driver</strong> instance variables),</li>
<li><strong>To send only changes</strong> &#8211; sending data to the client will be made only in case of change of a variable (if the state simply update &#8211; the value is not changed, the customer message will not be sent) from the client will be accepted any message, even if the value has not changed,</li>
<li><strong>To give private values at startup</strong> &#8211; for each successful client connection will be transferred to all known states (defined by the mask state) – in order to tell the client about the current state of the ioBroker,</li>
<li><strong>Post status subscribes</strong> &#8211; immediately after the subscription will be sent to the customer value of the variable on which it is signed (at the first start or restart the client will receive the values of variables on which it is signed, can be used to initialize variables),</li>
<li><strong>The prefix for all values</strong> &#8211; if the specified value, it will be added as a prefix to every sent topic, for example, if you specify iobroker/, then all topics sent along the following lines: <code>iobroker/mqtt/0/connected</code>,</li>
<li><strong>Output log for each change</strong> &#8211; in the log file will display debugging information for each change,</li>
<li><strong>To send not only commands, but also the state (ack=true)</strong> &#8211; if this option is not active, the client will only send variables/commands with ack=false, if the flag is set, then variables will be transferred regardless of the state of ack (false / true),</li>
<li><strong>The maximum length of the name of a topic</strong> &#8211; the maximum number of characters for the description of the topic, including service.</li>
</ul>
<p>As an example, consider the exchange of data between the client based on the <a href="https://www.arduino.cc/">arduino board</a> and the broker is an instance of mqtt.0 driver system ioBroker.</p>
<ul>
<li>&#8211; the client – the fee for developing <a href="https://www.arduino.cc/en/Main/ArduinoBoardUno">arduino UNO</a> + <a href="https://store.arduino.cc/product/A000072">ethernet shield</a> based on W5100 chip,</li>
<li>&#8211; to work with the ethernet board uses the standard <a href="https://www.arduino.cc/en/Reference/Ethernet">library </a> for working with MQTT library <a href="https://github.com/knolleary/pubsubclient">Pubsubclient</a>,</li>
<li>&#8211; the AM2302 sensor (temperature and humidity) connected to pin_8 for the survey used library with DHTlib with <a href="https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib">DHTlib</a> resource github.com,</li>
<li>&#8211; led <strong>led_green</strong> is connected to pin_9, control in discrete mode on/off</li>
<li>&#8211; broker – ioBroker system driver mqtt.</li>
</ul>
<p>Format topics of data exchange:</p>
<ul>
<li><code>example1/send_interval</code> &#8211; client signed to change the transmission interval of the temperature readings and humidity (int value in seconds),</li>
<li><code>example1/temp</code> &#8211; client publishes a specified temperature interval with DHT22 sensor (float type),</li>
<li><code>example1/hum</code> &#8211; client publishes a specified humidity value intervals with DHT22 sensor (float type),</li>
<li><code>example1/led</code> &#8211; the client is subscribed to the state change of the led (the text on/off or 0/1 or true/false).</li>
</ul>
<p>Driver settings will be as follows:</p>
<p><a href="wp-content\uploads\5.png"><img class="alignnone size-medium wp-image-6605" src="wp-content\uploads\5-283x300.png" alt="" width="283" height="300" srcset="wp-content\uploads\5-283x300.png 283w, wp-content\uploads\5-142x150.png 142w, wp-content\uploads\5-100x106.png 100w, wp-content\uploads\5-150x159.png 150w, wp-content\uploads\5-200x212.png 200w, wp-content\uploads\5-300x318.png 300w, wp-content\uploads\5-450x477.png 450w, wp-content\uploads\5-600x636.png 600w, wp-content\uploads\5.png 805w" sizes="(max-width: 283px) 100vw, 283px"></a></p>
<p>Connecting via TCP (WebSocket is not necessary), default port 1883. The client within the local network, so to encrypt traffic and authenticate the user is not necessary. We will send only the changes since the client signed on the send interval indications and led state to obtain information about the update (without changing the value) to a variable makes no sense.<br>
To publish the subscription &#8211; note this option, as when you first connect (or connected after disconnection) of the client, he must know the state of the variables on which it is signed (a current interval of sending and whether the LED is to be turned on). Setting to send variables ack = true or false is also worth noting, as a variable (which signed the client) can change any driver / script / VIS and any changes should be sent to the client.</p>
<p>The complete code for the arduino board will look like this:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cefa47a45969671438387" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
// Connecting libraries
#include
#include
#include //https://github.com/knolleary/pubsubclient
#include //https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib
//Settings of a network
byte mac[] = {
  0xAB,
  0xBC,
  0xCD,
  0xDE,
  0xEF,
  0x31
};
byte ip[] = {
  192,
  168,
  69,
  31
}; //arduino board IP address
byte mqttserver[] = {
  192,
  168,
  69,
  51
}; // ioBroker server IP address

EthernetClient ethClient;
void callback(char * topic, byte * payload, unsigned int length);
PubSubClient client(mqttserver, 1883, callback, ethClient);

//Global variables
#define LED_pin 9
unsigned int send_interval = 10; // the sending interval of indications to the server, by default 10 seconds
unsigned long last_time = 0; // the current time for the timer
dht DHT;
#define DHT22_PIN 8
char buff[20];

// The processing function for incoming connections - reception of data on a subscription
void callback(char * topic, byte * payload, unsigned int length) {
  Serial.println("");
  Serial.println("-------");
  Serial.println("New callback of MQTT-broker");
  // let's transform a subject (topic) and value (payload) to a line
  payload[length] = '\0';
  String strTopic = String(topic);
  String strPayload = String((char * ) payload);
  // research that "arrived" from the server on a subscription::
  // Change of an interval of inquiry
  if (strTopic == "example1/send_interval") {
    int tmp = strPayload.toInt();
    if (tmp == 0) {
      send_interval = 10;
    } else {
      send_interval = strPayload.toInt();
    }
  }
  // Control of a LED
  if (strTopic == "example1/led") {
    if (strPayload == "off" || strPayload == "0" || strPayload == "false") digitalWrite(LED_pin, LOW);
    if (strPayload == "on" || strPayload == "1" || strPayload == "true") digitalWrite(LED_pin, HIGH);
  }
  Serial.print(strTopic);
  Serial.print(" ");
  Serial.println(strPayload);
  Serial.println("-------");
  Serial.println("");
}

void setup() {
  Serial.begin(9600);
  Serial.println("Start...");
  // start network connection
  Ethernet.begin(mac, ip);
  Serial.print("IP: ");
  Serial.println(Ethernet.localIP());
  // initialize input/output ports, register starting values
  pinMode(LED_pin, OUTPUT);
  digitalWrite(LED_pin, LOW); // when the LED is off
}

void loop() {
  // If the MQTT connection inactively, then we try to set it and to publish/subscribe
  if (!client.connected()) {
    Serial.print("Connect to MQTT-boker... ");
    // Connect and publish / subscribe
    if (client.connect("example1")) {
      Serial.println("success");
      // Value from sensors
      if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
        dtostrf(DHT.humidity, 5, 2, buff);
        client.publish("example1/hum", buff);
        dtostrf(DHT.temperature, 5, 2, buff);
        client.publish("example1/temp", buff);
      }
      // subscribe for an inquiry interval
      client.subscribe("example1/send_interval");
      // subscribe to the LED control variable
      client.subscribe("example1/led");
    } else {
      // If weren't connected, we wait for 10 seconds and try again
      Serial.print("Failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 10 seconds");
      delay(10000);
    }
    // If connection is active, then sends the data to the server with the specified time interval
  } else {
    if (millis() &amp;amp; gt;
      (last_time + send_interval * 1000)) {
      last_time = millis();
      if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
        dtostrf(DHT.humidity, 5, 2, buff);
        client.publish("example1/hum", buff);
        dtostrf(DHT.temperature, 5, 2, buff);
        client.publish("example1/temp", buff);
      }
    }
  }
  // Check of incoming connections on a subscription
  client.loop();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-2">2</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-4">4</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-6">6</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-8">8</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-10">10</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-12">12</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-14">14</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-16">16</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-18">18</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-20">20</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-22">22</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-24">24</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-26">26</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-28">28</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-30">30</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-32">32</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-34">34</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-36">36</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-38">38</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-40">40</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-42">42</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-44">44</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-46">46</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-48">48</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-50">50</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-52">52</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-54">54</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-56">56</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-58">58</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-60">60</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-62">62</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-64">64</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-66">66</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-68">68</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-70">70</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-72">72</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-74">74</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-76">76</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-78">78</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-80">80</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-82">82</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-84">84</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-86">86</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-88">88</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-90">90</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-92">92</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-94">94</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-96">96</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-98">98</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-100">100</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-102">102</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-104">104</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-106">106</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-108">108</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-110">110</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-112">112</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-114">114</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-116">116</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-118">118</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-120">120</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45969671438387-122">122</div><div class="crayon-num" data-line="crayon-5cefa47a45969671438387-123">123</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5cefa47a45969671438387-1"><span class="crayon-c">// Connecting libraries</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-2"><span class="crayon-p">#include</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-3"><span class="crayon-p">#include</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-4"><span class="crayon-p">#include //https://github.com/knolleary/pubsubclient</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-5"><span class="crayon-p">#include //https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-6"><span class="crayon-c">//Settings of a network</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-7"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mac</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0xAB</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0xBC</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0xCD</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0xDE</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0xEF</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0x31</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-14"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-15"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">192</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">168</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">69</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">31</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-20"><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//arduino board IP address</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-21"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mqttserver</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-22"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">192</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">168</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">69</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">51</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-26"><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// ioBroker server IP address</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-27">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-28"><span class="crayon-e">EthernetClient </span><span class="crayon-v">ethClient</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-29"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-30"><span class="crayon-e">PubSubClient </span><span class="crayon-e">client</span><span class="crayon-sy">(</span><span class="crayon-v">mqttserver</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1883</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callback</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ethClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-31">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-32"><span class="crayon-c">//Global variables</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-33"><span class="crayon-p">#define LED_pin 9</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-34"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the sending interval of indications to the server, by default 10 seconds</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-35"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the current time for the timer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-36"><span class="crayon-e">dht </span><span class="crayon-v">DHT</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-37"><span class="crayon-p">#define DHT22_PIN 8</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-38"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">[</span><span class="crayon-cn">20</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-39">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-40"><span class="crayon-c">// The processing function for incoming connections - reception of data on a subscription</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-41"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-42"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-43"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-44"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"New callback of MQTT-broker"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-45"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// let's transform a subject (topic) and value (payload) to a line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">payload</span><span class="crayon-sy">[</span><span class="crayon-v">length</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\0'</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-47"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-v">topic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-48"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-49"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// research that "arrived" from the server on a subscription::</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-50"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Change of an interval of inquiry</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-51"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"example1/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-55"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-58"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-59"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Control of a LED</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-60"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"example1/led"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-61"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"off"</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"0"</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"false"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">digitalWrite</span><span class="crayon-sy">(</span><span class="crayon-v">LED_pin</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">LOW</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"on"</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"1"</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"true"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">digitalWrite</span><span class="crayon-sy">(</span><span class="crayon-v">LED_pin</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">HIGH</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-63"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-64"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-65"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">" "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-66"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">strPayload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-67"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-68"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-69"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-70">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a45969671438387-71"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">setup</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-72"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-cn">9600</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-73"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"Start..."</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-74"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// start network connection</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-75"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-v">mac</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-76"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"IP: "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-77"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">localIP</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-78"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// initialize input/output ports, register starting values</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-79"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">pinMode</span><span class="crayon-sy">(</span><span class="crayon-v">LED_pin</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">OUTPUT</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-80"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">digitalWrite</span><span class="crayon-sy">(</span><span class="crayon-v">LED_pin</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">LOW</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// when the LED is off</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-81"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-82">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a45969671438387-83"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-84"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// If the MQTT connection inactively, then we try to set it and to publish/subscribe</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-85"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connected</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-86"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Connect to MQTT-boker... "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-87"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Connect and publish / subscribe</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-88"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-s">"example1"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-89"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"success"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-90"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Value from sensors</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-91"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-92"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-95"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-96"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// subscribe for an inquiry interval</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">subscribe</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-99"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// subscribe to the LED control variable</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-100"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">subscribe</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/led"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-101"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-102"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If weren't connected, we wait for 10 seconds and try again</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-103"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed, rc="</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-104"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">state</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-105"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">" try again in 10 seconds"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-106"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">delay</span><span class="crayon-sy">(</span><span class="crayon-cn">10000</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-107"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-108"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If connection is active, then sends the data to the server with the specified time interval</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-109"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-110"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">gt</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-111"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">(</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e ">send_interval *</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-112"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-113"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-114"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-115"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-116"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-117"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example1/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-118"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-119"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-120"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-121"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// Check of incoming connections on a subscription</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45969671438387-122"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45969671438387-123"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0183 seconds] -->
<p>The result of the part of the broker (temperature and humidity data is updated with the preset time period):</p>
<p><a href="wp-content\uploads\6.png"><img class="alignnone size-large wp-image-6606" src="wp-content\uploads\6-1024x201.png" alt="" width="750" height="147" srcset="wp-content\uploads\6-1024x201.png 1024w, wp-content\uploads\6-150x29.png 150w, wp-content\uploads\6-300x59.png 300w, wp-content\uploads\6-100x20.png 100w, wp-content\uploads\6-200x39.png 200w, wp-content\uploads\6-450x88.png 450w, wp-content\uploads\6-600x118.png 600w, wp-content\uploads\6-900x177.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>The result of the client-side (incoming data subscription output to the console for debugging):</p>
<p><a href="wp-content\uploads\MQTT-server4.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-server4.jpg" width="400" height="580"></a></p>
<h3><span id="IoBroker_working_as_MQTT-client">IoBroker working as MQTT-client</span></h3>
<p>For an instance MQTT driver earned as a client / subscriber &#8211; you need to choose the appropriate type of configuration. In this set of options will change slightly:</p>
<p><a href="wp-content\uploads\4.png"><img class="alignnone wp-image-6604 size-medium" src="wp-content\uploads\4-282x300.png" width="282" height="300" srcset="wp-content\uploads\4-282x300.png 282w, wp-content\uploads\4-141x150.png 141w, wp-content\uploads\4-100x106.png 100w, wp-content\uploads\4-150x160.png 150w, wp-content\uploads\4-200x213.png 200w, wp-content\uploads\4-300x319.png 300w, wp-content\uploads\4-450x479.png 450w, wp-content\uploads\4-600x639.png 600w, wp-content\uploads\4.png 805w" sizes="(max-width: 282px) 100vw, 282px"></a></p>
<ul>
<li><strong>Connection settings</strong> &#8211; specifies the URL and port of the broker (if you want to encrypt traffic, indicated SSL) &#8211; settings to connect to the broker,</li>
<li><strong>Authentication settings</strong> &#8211; user name and password, if the broker requires authentication (it is appropriate to use SSL to avoid transmitting the password in clear text),</li>
<li><strong>Patterns</strong> &#8211; a mask for variables for which the customer subscribes (variables broker), the values are listed separated by commas, the # (pound) is used to indicate the set,</li>
<li><strong>Mask private values</strong> &#8211; filter variables that should be published (client variables) whose values are listed separated by commas, for indicating a set use the symbol * (asterisk),</li>
<li><strong>To send only changes</strong> &#8211; the client will publish only the variables that changed value (according to mask),</li>
<li><strong>To give private values at startup</strong> &#8211; if this option is checked, the will be <span id="result_box" lang="en"><span title="Publish all states at start - Publish all states (defined by state mask) every time by connection establishment to announce own available states and their values. ">published all the States (according to mask) every time a connection is established, to declare the available variables and their values,</span></span></li>
<li><strong>The prefix for all values</strong> &#8211; if the specified value, it will be added as a prefix to each published topic, for example, if you specify client1 /, then all topics will be published the following lines: <code>client1/javascript/0/cubietruck</code>,</li>
<li><strong>Output log for each change</strong> &#8211; in the log file will display debugging information for each change,</li>
<li><strong>To send not only the team, but also the state (ack = true)</strong> &#8211; if this option is not checked, the broker only sent variables / commands with ack = false, if the option to note that will be sent to all data, regardless of ack = true or ack = false,</li>
<li><strong>The maximum length of a topic</strong> &#8211; the maximum number of characters for the description of the topic, including service.</li>
</ul>
<p>Examples for setting the subscription mask variables (patterns). Consider topics:</p>
<ul>
<li>&#8220;Sport&#8221;</li>
<li>&#8220;Sport/Tennis&#8221;</li>
<li>&#8220;Sport/Basketball&#8221;</li>
<li>&#8220;Sport/Swimming&#8221;</li>
<li>&#8220;Sport/Tennis/Finals&#8221;</li>
<li>&#8220;Sport/Basketball/Finals&#8221;</li>
<li>&#8220;Sport/Swimming/Finals&#8221;</li>
</ul>
<p>If you want to subscribe to a certain set of topics, you can use the characters # (pound sign) or + (plus sign).</p>
<ul>
<li>&#8220;Sport/Tennis/#&#8221; (subscription only &#8220;Sport/Tennis&#8221; and &#8220;Sport/Tennis/Finals&#8221;)</li>
<li>&#8220;Sport/Tennis/+&#8221; (subscription only &#8220;Sport/Tennis/Finals&#8221;, but not &#8220;Sport/Tennis&#8221;)</li>
</ul>
<p>For JMS topics, if you want to subscribe to all topics &#8220;Finals&#8221;, you can use the characters # (pound sign) or + (plus sign)</p>
<ul>
<li>&#8220;Sport/#/Finals&#8221;</li>
<li>&#8220;Sport/+/Finals&#8221;</li>
</ul>
<p>For MQTT topics if you want to subscribe to all topics &#8220;Finals&#8221;, you can use the + (plus sign)</p>
<ul>
<li>&#8220;Sport/+/Finals&#8221;</li>
</ul>
<p>As an example, consider the exchange of data between the two systems ioBroker.</p>
<p>There is a working system ioBroker for BananaPi-Board (IP address 192.168.69.51), it launched MQTT- driver in the server/broker mode from the example above. To the server connects a client that publishes data from the sensor DHT22 – temperature and humidity, as well as signed variables of interval measurement transmission and the status led (enable/disable) – in the example above.</p>
<p>The second operating system ioBroker on the Board Cubietruck, it will run the MQTT driver in a client/subscriber mode. He signs up for the variables temperature and humidity of the broker (which, in turn, receives from another client) and will publish all the script variables &#8211; <a href="index-116.htm?page_id=4268&amp;lang=ru#_Li-polLi-ion">the state of the battery</a> board (only the changes).</p>
<p>Client configuration will be similar to the following:</p>
<p><a href="wp-content\uploads\7.png"><img class="alignnone size-medium wp-image-6607" src="wp-content\uploads\7-284x300.png" alt="" width="284" height="300" srcset="wp-content\uploads\7-284x300.png 284w, wp-content\uploads\7-142x150.png 142w, wp-content\uploads\7-100x106.png 100w, wp-content\uploads\7-150x158.png 150w, wp-content\uploads\7-200x211.png 200w, wp-content\uploads\7-300x317.png 300w, wp-content\uploads\7-450x475.png 450w, wp-content\uploads\7-600x634.png 600w, wp-content\uploads\7.png 805w" sizes="(max-width: 284px) 100vw, 284px"></a></p>
<p>Connection type – the customer/subscriber indicates the IP address of the broker and the port (default 1883). Traffic encryption and authentication is not needed. Mask for the subscriptions (Patterns) &#8211; <code>mqtt/0/example1/hum,mqtt/0/example1/temp</code> &#8211; client is subscribed only on temperature and humidity (values separated by comma without spaces). Mask the data for publication &#8211; <code>javascript.0.cubietruck.battery.*</code> &#8211; publish all the script variables <code>cubietruck</code> in the group <code>battery</code> driver <code>javascript.0</code>.</p>
<p>To send only the changes &#8211; send state variables batteries (makes no sense to send if the value has not changed). To give private values at startup – when starting the driver, the client immediately will release all variables according to the mask – even if they are null or empty to create variables in the broker. To send data with ack=false, variables work battery updated driver javascript, so they are always ack=false.</p>
<p>The result of the work on the client side (temperature and humidity data of another customer &#8211; see the example above):</p>
<p><a href="wp-content\uploads\9.png"><img class="alignnone size-large wp-image-6608" src="wp-content\uploads\9-1024x267.png" alt="" width="750" height="196" srcset="wp-content\uploads\9-1024x267.png 1024w, wp-content\uploads\9-150x39.png 150w, wp-content\uploads\9-300x78.png 300w, wp-content\uploads\9-100x26.png 100w, wp-content\uploads\9-200x52.png 200w, wp-content\uploads\9-450x117.png 450w, wp-content\uploads\9-600x157.png 600w, wp-content\uploads\9-900x235.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>The result of the broker (status data of the battery client):</p>
<p><a href="wp-content\uploads\11.png"><img class="alignnone size-large wp-image-6609" src="wp-content\uploads\11-1024x297.png" alt="" width="750" height="218" srcset="wp-content\uploads\11-1024x297.png 1024w, wp-content\uploads\11-150x44.png 150w, wp-content\uploads\11-300x87.png 300w, wp-content\uploads\11-100x29.png 100w, wp-content\uploads\11-200x58.png 200w, wp-content\uploads\11-450x131.png 450w, wp-content\uploads\11-600x174.png 600w, wp-content\uploads\11-900x261.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<h2><span id="Application_8211_MQTT_gateway_protocols_8211_ModBus_RTU">Application &#8211; MQTT gateway protocols &#8211; ModBus RTU</span></h2>
<p>Driver MQTT can be used as a gateway for various protocols to connect new devices to the system ioBroker or any other. A universal basis for the development of such solutions are arduino boards. In a network many examples, libraries and best practices. A huge community is working with these controllers, and the system integrated a variety of devices/equipment/devices. For example, consider the common industrial protocol ModBus. In ioBroker system has a driver to work with it &#8211; version ModBus TCP (over ethernet). A set of sensors, controllers and actuators work physically on the RS-485 Network / 232 and ModBus RTU protocol. In order to integrate them can be applied MQTT Gateway &#8211; ModBus RTU based on arduino platform. Consider an example.</p>
<p><span style="text-decoration: underline;"><strong>There is a temperature and humidity sensor </strong></span> (for the test on the basis of arduino pro mini board DHT22 Sensor), that outputs data via ModBUS RTU:</p>
<ul>
<li>Port UART (you can use MAX485 chip to convert RS-485 interface) running at 9600 with options 8E1 (1 start bit, 8 data bits, 1 Even parity bit, 1 stop bit),</li>
<li>the address of the ModBus – 10,</li>
<li>temperature address 0 the value multiplied by 10 (the reader function 3),</li>
<li>humidity – address 1 value multiplied by 10 (read function 3),</li>
<li>PWM LED address 2 value 0&#8230;1023 to check the recording function (write function 6).</li>
</ul>
<p>Connection scheme:</p>
<figure style="width: 401px" class="wp-caption alignnone"><a href="wp-content\uploads\MQTT-example-modbus1.jpg"><img src="wp-content\uploads\MQTT-example-modbus1.jpg" width="401" height="280"></a><figcaption class="wp-caption-text">by Fritzing</figcaption></figure>
<p>Code for arduino pro mini controller produces the following:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cefa47a45980796522476" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#include  //https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib
#include  //https://code.google.com/archive/p/simple-modbus/
#include  //https://github.com/PaulStoffregen/MsTimer2
// modbus registers
enum {
    TEMP,
    HUM,
    PWM,
    TEST,
    HOLDING_REGS_SIZE
};
#define ID_MODBUS 10 // modbus address of the slave device
unsigned int holdingRegs[HOLDING_REGS_SIZE]; // modbus register array
// temperature and humidity sensor DHT22
dht DHT;
#define DHT22_PIN 2
#define LED 9 // LED is connected to the PWM pin-9
void setup()
{
    // configure the modbus
    modbus_configure(&amp;amp; Serial, 9600, SERIAL_8E1, ID_MODBUS, 0, HOLDING_REGS_SIZE, holdingRegs);
    holdingRegs[TEST] = -157; // for the test of the negative values
    // initialize a timer for 2 seconds update data in temperature and humidity registers
    MsTimer2::set(2000, read_sensors);
    MsTimer2::start(); // run timer
    pinMode(LED, OUTPUT); // LED port initialization
}
// the function launched by timer each 2 seconds
void read_sensors()
{
    if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
        if
            data from the sensor DHT22 managed to be read
                // we write integer value in the register of humidity
                holdingRegs[HUM]
                = 10 * DHT.humidity;
        // we write integer value in the register of temperature
        holdingRegs[TEMP] = 10 * DHT.temperature;
    }
    else {
        // if it wasn't succeeded to read data from the sensor DHT22, we write zero in registers
        holdingRegs[HUM] = 0;
        holdingRegs[TEMP] = 0;
    }
}
void loop()
{
    modbus_update(); // modbus data update
    // data from the LED control register transmit to the PWM (bit shift by 2 bits)
    analogWrite(LED, holdingRegs[PWM] &amp;amp; gt; &amp;gt; 2);
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-2">2</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-4">4</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-6">6</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-8">8</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-10">10</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-12">12</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-14">14</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-16">16</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-18">18</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-20">20</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-22">22</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-24">24</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-26">26</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-28">28</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-30">30</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-32">32</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-34">34</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-36">36</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-38">38</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-40">40</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-42">42</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-44">44</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-46">46</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-48">48</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45980796522476-50">50</div><div class="crayon-num" data-line="crayon-5cefa47a45980796522476-51">51</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5cefa47a45980796522476-1"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-2"><span class="crayon-p">#include&nbsp;&nbsp;//https://code.google.com/archive/p/simple-modbus/</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-3"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/PaulStoffregen/MsTimer2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-4"><span class="crayon-c">// modbus registers</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-5"><span class="crayon-t">enum</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">TEMP</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">HUM</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">PWM</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">TEST</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">HOLDING_REGS</span><span class="crayon-sy">_</span>SIZE</div><div class="crayon-line" id="crayon-5cefa47a45980796522476-11"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-12"><span class="crayon-p">#define ID_MODBUS 10 // modbus address of the slave device</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-13"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">HOLDING_REGS_SIZE</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// modbus register array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-14"><span class="crayon-c">// temperature and humidity sensor DHT22</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-15"><span class="crayon-e">dht </span><span class="crayon-v">DHT</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-16"><span class="crayon-p">#define DHT22_PIN 2</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-17"><span class="crayon-p">#define LED 9 // LED is connected to the PWM pin-9</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-18"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">setup</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-19"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// configure the modbus</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">modbus_configure</span><span class="crayon-sy">(</span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">Serial</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">9600</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SERIAL_8E1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ID_MODBUS</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">HOLDING_REGS_SIZE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">TEST</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">157</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// for the test of the negative values</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// initialize a timer for 2 seconds update data in temperature and humidity registers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">MsTimer2</span><span class="crayon-o">::</span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-cn">2000</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">read_sensors</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">MsTimer2</span><span class="crayon-o">::</span><span class="crayon-e">start</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// run timer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">pinMode</span><span class="crayon-sy">(</span><span class="crayon-v">LED</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">OUTPUT</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// LED port initialization</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-27"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-28"><span class="crayon-c">// the function launched by timer each 2 seconds</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-29"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">read_sensors</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-30"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">data </span><span class="crayon-e">from </span><span class="crayon-e">the </span><span class="crayon-e">sensor </span><span class="crayon-e">DHT22 </span><span class="crayon-e">managed </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">be </span><span class="crayon-v">read</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// we write integer value in the register of humidity</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">HUM</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// we write integer value in the register of temperature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">TEMP</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// if it wasn't succeeded to read data from the sensor DHT22, we write zero in registers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">HUM</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">TEMP</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-45"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-46"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-47"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">modbus_update</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// modbus data update</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// data from the LED control register transmit to the PWM (bit shift by 2 bits)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45980796522476-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">analogWrite</span><span class="crayon-sy">(</span><span class="crayon-v">LED</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">holdingRegs</span><span class="crayon-sy">[</span><span class="crayon-v">PWM</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45980796522476-51"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0068 seconds] -->
<p>To test the operation code and schema, you can connect to port serial board (for example, using a USB-UART Converter) and a special program to interview just made the temperature sensor and humidity with ModBus RTU interface. For the survey can be used, for example, <a href="http://qmodbus.sourceforge.net/">qmodbus</a> or any other program.</p>
<p>Settings:</p>
<ul>
<li>port (choose from the list which port is connected to the serial Arduino boards);</li>
<li>speed and other parameters – 9600 8E1;</li>
<li>slave id: 10, read: function No. 3 read holding registers, starting address: 0, number of registers: 3,</li>
<li>slave id: 10, record: function No. 6 write single register start address: 2,</li>
</ul>
<p>The answer in the program when reading should be approximately the following:</p>
<p><a href="wp-content\uploads\MQTT-example-modbus2.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-modbus2.jpg" width="401" height="242"></a></p>
<p>The answer in the program when recording:</p>
<p><a href="wp-content\uploads\MQTT-example-modbus3.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-modbus3.jpg" width="400" height="241"></a></p>
<p><span style="text-decoration: underline;"><strong>Now configure the gateway itself and connect it to the iobroker</strong></span></p>
<p>The gateway will be based on the platform arduino MEGA 2560 with ethernet shield &#8211; client MQTT, broker &#8211; an instance mqtt.0 ioBroker system driver. Choosing the MEGA 2560 due to the fact that on this Board more than one UART port, respectively, is zero Serial0 (pin_0 (RX) and pin_1 (TX)) or simply Serial – use to output debug messages, and Serial1 (pin_19 (RX) and pin_18 (TX)) – for slave via ModBus.</p>
<ul>
<li>the client – the fee for developing arduino MEGA 2560 + ethernet shield based on W5100 chip;</li>
<li>to work with the ethernet board uses the <a href="https://www.arduino.cc/en/Reference/Ethernet">standard library</a> for working with MQTT library <a href="https://github.com/knolleary/pubsubclient">Pubsubclient</a>;</li>
<li>for the survey on the modbus use library <a href="https://code.google.com/archive/p/simple-modbus/">SimpleModbus</a> version master;</li>
<li>survey on UART port (just connect the RX port master, TX port slave and respectively TX port master, RX port slave), transmission control port is not used (it is for RS-485);</li>
<li>port settings: speed 9600, 8Е1;</li>
<li>&#8211; the address of the slave device 10, a function of reading number 3 (read holding registers), recording function no. 6 (write single register);</li>
<li>&#8211; broker – ioBroker system driver mqtt.</li>
</ul>
<p>Format topics of data exchange:</p>
<ul>
<li><code>modbusgateway/send_interval</code> &#8211; client signed to change the transmission interval of the temperature readings and humidity (int value in seconds),</li>
<li><code>modbusgateway/temp</code> &#8211; client publishes with a a given interval the value of the temperature sensor DHT22 (type float),</li>
<li><code>modbusgateway/hum</code> &#8211; the client publishes with a given interval the value of the humidity sensor DHT22 (type float),</li>
<li><code>modbusgateway/led</code> &#8211; the client is subscribed to the state change of the led (PWM control value 0&#8230;1024).</li>
</ul>
<p>СThe connection diagram will look something like this:</p>
<figure style="width: 699px" class="wp-caption alignnone"><a href="wp-content\uploads\MQTT-example-modbus6.jpg"><img src="wp-content\uploads\MQTT-example-modbus6.jpg" width="699" height="250"></a><figcaption class="wp-caption-text">By Fritzing</figcaption></figure>
<p>For the test slave device energized from the master device. The Master in turn will work from the USB port, which is being debug (Serial0).</p>
<p>Driver settings will be as follows:</p>
<p><a href="wp-content\uploads\14.png"><img class="alignnone size-medium wp-image-6610" src="wp-content\uploads\14-283x300.png" alt="" width="283" height="300" srcset="wp-content\uploads\14-283x300.png 283w, wp-content\uploads\14-142x150.png 142w, wp-content\uploads\14-100x106.png 100w, wp-content\uploads\14-150x159.png 150w, wp-content\uploads\14-200x212.png 200w, wp-content\uploads\14-300x318.png 300w, wp-content\uploads\14-450x477.png 450w, wp-content\uploads\14-600x636.png 600w, wp-content\uploads\14.png 805w" sizes="(max-width: 283px) 100vw, 283px"></a></p>
<p>Connecting via TCP (WebSocket is not necessary), default port 1883. The client within the local network, so to encrypt traffic and authenticate the user is not necessary. We will send only the changes since the client signed on the send interval indications and led state to obtain information about the update (without changing the value) to a variable makes no sense. To publish the subscription &#8211; note this option, as when you first connect (or connected after disconnection) of the client, he must know the state of the variables on which it is signed (a current interval of sending and whether the LED is to be turned on). Setting to send variables ack = true or false is also worth noting, as a variable (which signed the client) can change any driver / script / VIS and any changes should be sent to the client.</p>
<p>The complete code for the arduino board will look like this:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cefa47a4598c242129231" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
// Connecting libraries
#include 
#include 
#include  //https://github.com/knolleary/pubsubclient
#include  //https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib

// Settings of a network
byte mac[] = { 0xAB, 0xBC, 0xCD, 0xDE, 0xEF, 0x31 };
byte ip[] = { 192, 168, 69, 31 }; // arduino board IP address
byte mqttserver[] = { 192, 168, 69, 51 }; // ioBroker server IP address
EthernetClient ethClient;
void callback(char* topic, byte* payload, unsigned int length);
PubSubClient client(mqttserver, 1884, callback, ethClient);
// Global variables
unsigned int send_interval = 10; // the sending interval of indications to the server, by default 10 seconds
unsigned long last_time = 0; // the current time for the timer
dht DHT;
#define DHT22_PIN 8
char buff[20];

//The processing function for incoming connections - reception of data on a subscription
void callback(char* topic, byte* payload, unsigned int length)
{
    Serial.println("");
    Serial.println("-------");
    Serial.println("New callback of MQTT-broker");
    // let's transform a subject (topic) and value (payload) to a line
    payload[length] = '\0';
    String strTopic = String(topic);
    String strPayload = String((char*)payload);
    // Research that "arrived" from the server on a subscription:
    // Change of an interval of inquiry
    if (strTopic == "example2/send_interval") {
        int tmp = strPayload.toInt();
        if (tmp == 0) {
            send_interval = 10;
        }
        else {
            send_interval = strPayload.toInt();
        }
    }
    Serial.print(strTopic);
    Serial.print(" ");
    Serial.println(strPayload);
    Serial.println("-------");
    Serial.println("");
}

void setup()
{
    Serial.begin(9600);
    Serial.println("Start...");
    // start network connection
    Ethernet.begin(mac, ip);
    Serial.print("IP: ");
    Serial.println(Ethernet.localIP());
    // initialize input/output ports, register starting values
}

void loop()
{
    // If the MQTT connection inactively, then we try to set it and to publish/subscribe
    if (!client.connected()) {
        Serial.print("Connect to MQTT-boker... ");
        // Connect and publish / subscribe
        if (client.connect("example2")) {
            Serial.println("success");
            // Value from sensors
            if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
                dtostrf(DHT.humidity, 5, 2, buff);
                client.publish("example2/hum", buff);
                dtostrf(DHT.temperature, 5, 2, buff);
                client.publish("example2/temp", buff);
            }
            // Subscribe for an inquiry interval
            client.subscribe("example2/send_interval");
        }
        else {
            // If weren't connected, we wait for 10 seconds and try again
            Serial.print("Failed, rc=");
            Serial.print(client.state());
            Serial.println(" try again in 10 seconds");
            delay(10000);
        }
        // If connection is active, then sends the data to the server with the specified time interval
    }
    else {
        if (millis() &amp;amp; gt; (last_time + send_interval * 1000)) {
            last_time = millis();
            if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
                dtostrf(DHT.humidity, 5, 2, buff);
                client.publish("example2/hum", buff);
                dtostrf(DHT.temperature, 5, 2, buff);
                client.publish("example2/temp", buff);
            }
        }
    }
    // Check of incoming connections on a subscription
    client.loop();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-2">2</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-4">4</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-6">6</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-8">8</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-10">10</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-12">12</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-14">14</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-16">16</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-18">18</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-20">20</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-22">22</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-24">24</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-26">26</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-28">28</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-30">30</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-32">32</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-34">34</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-36">36</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-38">38</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-40">40</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-42">42</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-44">44</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-46">46</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-48">48</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-50">50</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-52">52</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-54">54</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-56">56</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-58">58</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-60">60</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-62">62</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-64">64</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-66">66</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-68">68</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-70">70</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-72">72</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-74">74</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-76">76</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-78">78</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-80">80</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-82">82</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-84">84</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-86">86</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-88">88</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-90">90</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-92">92</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-94">94</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-96">96</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-98">98</div><div class="crayon-num" data-line="crayon-5cefa47a4598c242129231-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4598c242129231-100">100</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5cefa47a4598c242129231-1"><span class="crayon-c">// Connecting libraries</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-2"><span class="crayon-p">#include </span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-3"><span class="crayon-p">#include </span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-4"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/knolleary/pubsubclient</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-5"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-6">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-7"><span class="crayon-c">// Settings of a network</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-8"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mac</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">0xAB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xBC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xCD</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xDE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xEF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x31</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-9"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">192</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">168</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">69</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">31</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// arduino board IP address</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-10"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mqttserver</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">192</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">168</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">69</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">51</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// ioBroker server IP address</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-11"><span class="crayon-e">EthernetClient </span><span class="crayon-v">ethClient</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-12"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-13"><span class="crayon-e">PubSubClient </span><span class="crayon-e">client</span><span class="crayon-sy">(</span><span class="crayon-v">mqttserver</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1884</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callback</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ethClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-14"><span class="crayon-c">// Global variables</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-15"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the sending interval of indications to the server, by default 10 seconds</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-16"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the current time for the timer</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-17"><span class="crayon-e">dht </span><span class="crayon-v">DHT</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-18"><span class="crayon-p">#define DHT22_PIN 8</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-19"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">[</span><span class="crayon-cn">20</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-20">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-21"><span class="crayon-c">//The processing function for incoming connections - reception of data on a subscription</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-22"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-23"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"New callback of MQTT-broker"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// let's transform a subject (topic) and value (payload) to a line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">payload</span><span class="crayon-sy">[</span><span class="crayon-v">length</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\0'</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-v">topic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">payload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Research that "arrived" from the server on a subscription:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Change of an interval of inquiry</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"example2/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">" "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">strPayload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-47"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-48">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-49"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">setup</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-50"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-cn">9600</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"Start..."</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// start network connection</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-v">mac</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-55"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"IP: "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">localIP</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-57"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// initialize input/output ports, register starting values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-58"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-59">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-60"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-61"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If the MQTT connection inactively, then we try to set it and to publish/subscribe</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-63"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connected</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-64"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Connect to MQTT-boker... "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-65"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Connect and publish / subscribe</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-s">"example2"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"success"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Value from sensors</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-70"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-72"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-73"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-74"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-75"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Subscribe for an inquiry interval</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-76"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">subscribe</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-77"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-78"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-79"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If weren't connected, we wait for 10 seconds and try again</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-80"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed, rc="</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-81"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">state</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-82"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">" try again in 10 seconds"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-83"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">delay</span><span class="crayon-sy">(</span><span class="crayon-cn">10000</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-85"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If connection is active, then sends the data to the server with the specified time interval</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-86"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-87"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-88"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e ">send_interval *</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-89"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-90"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-91"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-92"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-95"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-96"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Check of incoming connections on a subscription</span></div><div class="crayon-line" id="crayon-5cefa47a4598c242129231-99"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4598c242129231-100"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0153 seconds] -->
<p>This solution can be used as a prototype (example) ModBus network in your automation system. The data from the slave is transmitted with the desired spacing in the ioBroker.</p>
<p><a href="wp-content\uploads\10.png"><img class="alignnone size-large wp-image-6611" src="wp-content\uploads\10-1024x202.png" alt="" width="750" height="148" srcset="wp-content\uploads\10-1024x202.png 1024w, wp-content\uploads\10-150x30.png 150w, wp-content\uploads\10-300x59.png 300w, wp-content\uploads\10-100x20.png 100w, wp-content\uploads\10-200x39.png 200w, wp-content\uploads\10-450x89.png 450w, wp-content\uploads\10-600x118.png 600w, wp-content\uploads\10-900x177.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>MQTT client signed variables and redirects needed in slave-device on the ModBus network.</p>
<p><a href="wp-content\uploads\MQTT-example-modbus5.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-modbus5.jpg" width="400" height="580"></a></p>
<h2><span id="Application_8211_connecting_mobile_clients">Application &#8211; connecting mobile clients</span></h2>
<p>Recently MQTT protocol became very common due to the simplicity, economy of the traffic and the elaboration of good libraries for different platforms. There are many programs to work with MQTT on mobile devices, for example <a href="https://play.google.com/store/apps/details?id=com.thn.iotmqttdashboard&hl=en">IoT MQTT Dashboard</a>. With this program you can connect to the MQTT broker in a local network or the Internet. Consider an example, in the role of the broker will be the ioBroker system, to which using MQTT to connect the client – application IoT MQTT Dashboard.</p>
<p>In this example, we control the light controller <a href="http://www.ab-log.ru/smart-house/ethernet/megad-328">MegaD-328</a>, which is connected to the ioBroker with the driver <a href="?page_id=4052&lang=en">MegaD</a>. Controls relay (MegaD port <strong>P7</strong>) light in the lobby, a special script, which is signed by the state of the port &#8211; button <strong>P0</strong> and MQTT-variable state <strong>mqtt.0.remotectrl.light.hall</strong>, which will publish the mobile client. This script toggles the state of the port that is bound to the switch (port P7), ie inverts it. It turns out that each time you press the button, electrically connected to port <strong>P0</strong> (caught the <strong>true</strong> state) and every time you publish variable <strong>mqtt.0.remotectrl.light.hall </strong> value as <strong>true</strong>, the port <strong>P7</strong> to turn on or off the light.</p>
<p>The text of the script will be like this:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cefa47a45996556407802" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
// Control of lighting in the hall by means of the button p0 port of the MegaD controller the driver instance megad.0
on({ id : 'megad.0.p0_P0', change : 'any' }, function(obj) {
    if (obj.newState.val != = '' || typeof obj.newState.val != = "undefined") {
        if (obj.newState.val == = true) {
            if (getState('megad.0.p7_P7').val == = true) {
                setState('megad.0.p7_P7', false);
            }
            else {
                setState('megad.0.p7_P7', true);
            }
        }
    }
});
// Control of lighting in the hall is remote on MQTT a topic "mqtt.0.remotectrl.light.hall"
on({ id : 'mqtt.0.remotectrl.light.hall', change : 'any' }, function(obj) {
    if (obj.newState.val != = '' || typeof obj.newState.val != = "undefined") {
        if (obj.newState.val == = true) {
            if (getState('megad.0.p7_P7').val == = true) {
                setState('megad.0.p7_P7', false);
            }
            else {
                setState('megad.0.p7_P7', true);
            }
        }
    }
});</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-2">2</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-4">4</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-6">6</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-8">8</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-10">10</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-12">12</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-14">14</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-16">16</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-18">18</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-20">20</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-22">22</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-24">24</div><div class="crayon-num" data-line="crayon-5cefa47a45996556407802-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a45996556407802-26">26</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5cefa47a45996556407802-1"><span class="crayon-c">// Control of lighting in the hall by means of the button p0 port of the MegaD controller the driver instance megad.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-2"><span class="crayon-e">on</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'megad.0.p0_P0'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">change</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'any'</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-e">typeof </span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"undefined"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">getState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-13"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-14"><span class="crayon-c">// Control of lighting in the hall is remote on MQTT a topic "mqtt.0.remotectrl.light.hall"</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-15"><span class="crayon-e">on</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">id</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'mqtt.0.remotectrl.light.hall'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">change</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">'any'</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">function</span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-h"> </span><span class="crayon-o">||</span><span class="crayon-h"> </span><span class="crayon-e">typeof </span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"undefined"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-17"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">obj</span><span class="crayon-sy">.</span><span class="crayon-v">newState</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-18"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">getState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-v">val</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">setState</span><span class="crayon-sy">(</span><span class="crayon-s">'megad.0.p7_P7'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a45996556407802-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a45996556407802-26"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0067 seconds] -->
<p>Connect button and light bulbs to MegaD controller:</p>
<p><a href="wp-content\uploads\mqtt-mobile1.jpg"><img class="alignnone wp-image-6618 size-full" src="wp-content\uploads\mqtt-mobile1.jpg" width="620" height="899" srcset="wp-content\uploads\mqtt-mobile1.jpg 620w, wp-content\uploads\mqtt-mobile1-103x150.jpg 103w, wp-content\uploads\mqtt-mobile1-207x300.jpg 207w, wp-content\uploads\mqtt-mobile1-100x145.jpg 100w, wp-content\uploads\mqtt-mobile1-150x218.jpg 150w, wp-content\uploads\mqtt-mobile1-200x290.jpg 200w, wp-content\uploads\mqtt-mobile1-300x435.jpg 300w, wp-content\uploads\mqtt-mobile1-450x653.jpg 450w, wp-content\uploads\mqtt-mobile1-600x870.jpg 600w" sizes="(max-width: 620px) 100vw, 620px"></a></p>
<p>MQTT driver settings:</p>
<p><a href="wp-content\uploads\14.png"><img class="alignnone size-medium wp-image-6610" src="wp-content\uploads\14-283x300.png" alt="" width="283" height="300" srcset="wp-content\uploads\14-283x300.png 283w, wp-content\uploads\14-142x150.png 142w, wp-content\uploads\14-100x106.png 100w, wp-content\uploads\14-150x159.png 150w, wp-content\uploads\14-200x212.png 200w, wp-content\uploads\14-300x318.png 300w, wp-content\uploads\14-450x477.png 450w, wp-content\uploads\14-600x636.png 600w, wp-content\uploads\14.png 805w" sizes="(max-width: 283px) 100vw, 283px"></a></p>
<p>The mobile client can publish data to variable mqtt.0.remotectrl.light.hall and signs up for a real port status MegaD – megad.0.p7_P7. The configure publishing and subscriptions:</p>
<p><a href="wp-content\uploads\MQTT-example-mobile3.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-mobile3.png" width="300" height="512"> </a><a href="wp-content\uploads\MQTT-example-mobile4.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-mobile4.png" width="300" height="512"></a></p>
<p>In total for one channel light control turn the control window (publish) and subscription window is a real condition light relay (for feedback):</p>
<p><a href="wp-content\uploads\MQTT-example-mobile6.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-mobile5.png" width="300" height="512"> <img class="alignnone" src="wp-content\uploads\MQTT-example-mobile6.png" width="300" height="512"></a></p>
<h2><span id="Application_8211_working_with_cloud_servers">Application &#8211; working with cloud servers</span></h2>
<p>The example described above has several disadvantages. First, it is not always the mobile client may be on the same local network as the server ioBroker, and secondly, even if you implement port forwarding in the Internet and to protect the connection, not always the server itself ioBroker can accept incoming connection (located behind a NAT which has no access to settings). In the global network many different services that support MQTT &#8211; paid and free, for example sending weather data, geolocation, etc. Some services may act as MQTT protocol broker and can be used as a gateway (bridge) to output data from ioBroker the global network, or to obtain data in ioBroker.</p>
<p>As an example, consider the work of the bundles:</p>
<ul>
<li>server / broker &#8211; service <a href="https://www.cloudmqtt.com/">cloudmqtt.com</a> (there is a free tariff),</li>
<li>customer/subscriber – the ioBroker system with access to the Internet, publishes data of temperature and humidity (see <a href="index-88.htm?page_id=6435&amp;lang=en#ioBroker_working_as_MQTT-broker">example above</a>), publishes the real status of ports <strong>P7-P13</strong> (relay driver MegaD <strong>megad.0</strong> – light control), subscribing to properties of the remote light control (an instance of the driver mqtt <strong>mqtt.0</strong>),</li>
<li>customer/subscriber – the application of <a href="https://play.google.com/store/apps/details?id=com.thn.iotmqttdashboard&hl=en">IoT MQTT Dashboard</a> to work remotely – subscribe to sensor data of temperature and humidity, subscription to the real status of ports <strong>P7-P13</strong> (relay driver MegaD <strong>megad.0</strong>), publication of variables of a remote control light (driver instance <strong>mqtt.0</strong>).</li>
</ul>
<p>he result is the following structure:</p>
<p><a href="wp-content\uploads\mqtt-cloud1.jpg"><img class="alignnone wp-image-6619 size-large" src="wp-content\uploads\mqtt-cloud1-1024x511.jpg" width="750" height="374" srcset="wp-content\uploads\mqtt-cloud1-1024x511.jpg 1024w, wp-content\uploads\mqtt-cloud1-150x75.jpg 150w, wp-content\uploads\mqtt-cloud1-300x150.jpg 300w, wp-content\uploads\mqtt-cloud1-100x50.jpg 100w, wp-content\uploads\mqtt-cloud1-200x100.jpg 200w, wp-content\uploads\mqtt-cloud1-450x225.jpg 450w, wp-content\uploads\mqtt-cloud1-600x300.jpg 600w, wp-content\uploads\mqtt-cloud1-900x449.jpg 900w, wp-content\uploads\mqtt-cloud1.jpg 1414w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>Bundle driver <strong>mqtt.1</strong> (broker) – Arduino UNO + Ethernet + DHT22 (client) as in <a href="index-88.htm?page_id=6435&amp;lang=en#ioBroker_working_as_MQTT-broker">the example above</a> with a few modifications. Configuring an instance of the mqtt <strong>driver.1</strong>:</p>
<p><a href="wp-content\uploads\14.png"><img class="alignnone size-medium wp-image-6610" src="wp-content\uploads\14-283x300.png" alt="" width="283" height="300" srcset="wp-content\uploads\14-283x300.png 283w, wp-content\uploads\14-142x150.png 142w, wp-content\uploads\14-100x106.png 100w, wp-content\uploads\14-150x159.png 150w, wp-content\uploads\14-200x212.png 200w, wp-content\uploads\14-300x318.png 300w, wp-content\uploads\14-450x477.png 450w, wp-content\uploads\14-600x636.png 600w, wp-content\uploads\14.png 805w" sizes="(max-width: 283px) 100vw, 283px"></a></p>
<p>Code for the arduino platform:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5cefa47a4599f767357027" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
		
			<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
			<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
			<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
			<div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
// Connecting libraries
#include 
#include 
#include  //https://github.com/knolleary/pubsubclient
#include  //https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib

// Settings of a network
byte mac[] = { 0xAB, 0xBC, 0xCD, 0xDE, 0xEF, 0x31 };
byte ip[] = { 192, 168, 69, 31 }; // arduino board IP address
byte mqttserver[] = { 192, 168, 69, 51 }; // ioBroker server IP address
EthernetClient ethClient;
void callback(char* topic, byte* payload, unsigned int length);
PubSubClient client(mqttserver, 1884, callback, ethClient);
// Global variables
unsigned int send_interval = 10; // the sending interval of indications to the server, by default 10 seconds
unsigned long last_time = 0; // the current time for the timer
dht DHT;
#define DHT22_PIN 8
char buff[20];
//The processing function for incoming connections - reception of data on a subscription
void callback(char* topic, byte* payload, unsigned int length)
{
    Serial.println("");
    Serial.println("-------");
    Serial.println("New callback of MQTT-broker");
    // let's transform a subject (topic) and value (payload) to a line
    payload[length] = '\0';
    String strTopic = String(topic);
    String strPayload = String((char*)payload);
    // Research that "arrived" from the server on a subscription:
    // Change of an interval of inquiry
    if (strTopic == "example2/send_interval") {
        int tmp = strPayload.toInt();
        if (tmp == 0) {
            send_interval = 10;
        }
        else {
            send_interval = strPayload.toInt();
        }
    }
    Serial.print(strTopic);
    Serial.print(" ");
    Serial.println(strPayload);
    Serial.println("-------");
    Serial.println("");
}

void setup()
{
    Serial.begin(9600);
    Serial.println("Start...");
    // start network connection
    Ethernet.begin(mac, ip);
    Serial.print("IP: ");
    Serial.println(Ethernet.localIP());
    // initialize input/output ports, register starting values
}

void loop()
{
    // If the MQTT connection inactively, then we try to set it and to publish/subscribe
    if (!client.connected()) {
        Serial.print("Connect to MQTT-boker... ");
        // Connect and publish / subscribe
        if (client.connect("example2")) {
            Serial.println("success");
            // Value from sensors
            if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
                dtostrf(DHT.humidity, 5, 2, buff);
                client.publish("example2/hum", buff);
                dtostrf(DHT.temperature, 5, 2, buff);
                client.publish("example2/temp", buff);
            }
            // Subscribe for an inquiry interval
            client.subscribe("example2/send_interval");
        }
        else {
            // If weren't connected, we wait for 10 seconds and try again
            Serial.print("Failed, rc=");
            Serial.print(client.state());
            Serial.println(" try again in 10 seconds");
            delay(10000);
        }
        // If connection is active, then sends the data to the server with the specified time interval
    }
    else {
        if (millis() &amp;amp; gt; (last_time + send_interval * 1000)) {
            last_time = millis();
            if (DHT.read22(DHT22_PIN) == DHTLIB_OK) {
                dtostrf(DHT.humidity, 5, 2, buff);
                client.publish("example2/hum", buff);
                dtostrf(DHT.temperature, 5, 2, buff);
                client.publish("example2/temp", buff);
            }
        }
    }
    // Check of incoming connections on a subscription
    client.loop();
}</textarea></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tr class="crayon-row">
				<td class="crayon-nums " data-settings="show">
					<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-2">2</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-4">4</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-6">6</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-8">8</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-10">10</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-12">12</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-14">14</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-16">16</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-18">18</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-20">20</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-22">22</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-24">24</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-26">26</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-28">28</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-30">30</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-32">32</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-34">34</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-36">36</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-38">38</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-40">40</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-42">42</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-44">44</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-46">46</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-48">48</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-50">50</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-52">52</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-54">54</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-56">56</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-58">58</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-60">60</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-62">62</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-64">64</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-66">66</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-68">68</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-70">70</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-72">72</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-74">74</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-76">76</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-78">78</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-80">80</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-82">82</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-84">84</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-86">86</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-88">88</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-90">90</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-92">92</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-94">94</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-96">96</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5cefa47a4599f767357027-98">98</div><div class="crayon-num" data-line="crayon-5cefa47a4599f767357027-99">99</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5cefa47a4599f767357027-1"><span class="crayon-c">// Connecting libraries</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-2"><span class="crayon-p">#include </span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-3"><span class="crayon-p">#include </span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-4"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/knolleary/pubsubclient</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-5"><span class="crayon-p">#include&nbsp;&nbsp;//https://github.com/RobTillaart/Arduino/tree/master/libraries/DHTlib</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-6">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-7"><span class="crayon-c">// Settings of a network</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-8"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mac</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">0xAB</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xBC</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xCD</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xDE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0xEF</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0x31</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-9"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">192</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">168</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">69</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">31</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// arduino board IP address</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-10"><span class="crayon-t">byte</span><span class="crayon-h"> </span><span class="crayon-v">mqttserver</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-cn">192</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">168</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">69</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">51</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// ioBroker server IP address</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-11"><span class="crayon-e">EthernetClient </span><span class="crayon-v">ethClient</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-12"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-13"><span class="crayon-e">PubSubClient </span><span class="crayon-e">client</span><span class="crayon-sy">(</span><span class="crayon-v">mqttserver</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1884</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callback</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ethClient</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-14"><span class="crayon-c">// Global variables</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-15"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the sending interval of indications to the server, by default 10 seconds</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-16"><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// the current time for the timer</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-17"><span class="crayon-e">dht </span><span class="crayon-v">DHT</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-18"><span class="crayon-p">#define DHT22_PIN 8</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-19"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">[</span><span class="crayon-cn">20</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-20"><span class="crayon-c">//The processing function for incoming connections - reception of data on a subscription</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-21"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">callback</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">topic</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">byte</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">payload</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">unsigned</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-22"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"New callback of MQTT-broker"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// let's transform a subject (topic) and value (payload) to a line</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">payload</span><span class="crayon-sy">[</span><span class="crayon-v">length</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\0'</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-v">topic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">String</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">String</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">payload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Research that "arrived" from the server on a subscription:</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Change of an interval of inquiry</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">"example2/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">tmp</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">send_interval</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">strPayload</span><span class="crayon-sy">.</span><span class="crayon-e">toInt</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">strTopic</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">" "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">strPayload</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"-------"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-45"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">""</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-46"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-47">&nbsp;</div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-48"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">setup</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-49"><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-cn">9600</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-51"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"Start..."</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-52"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// start network connection</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-53"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">begin</span><span class="crayon-sy">(</span><span class="crayon-v">mac</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ip</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-54"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"IP: "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-55"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-v">Ethernet</span><span class="crayon-sy">.</span><span class="crayon-e">localIP</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-56"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// initialize input/output ports, register starting values</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-57"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-58">&nbsp;</div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-59"><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-60"><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-61"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If the MQTT connection inactively, then we try to set it and to publish/subscribe</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-62"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connected</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-63"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Connect to MQTT-boker... "</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-64"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Connect and publish / subscribe</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-65"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">connect</span><span class="crayon-sy">(</span><span class="crayon-s">"example2"</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-66"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">"success"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-67"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Value from sensors</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-68"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-69"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-70"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-71"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-72"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-73"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-74"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Subscribe for an inquiry interval</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-75"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">subscribe</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/send_interval"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-76"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-77"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-78"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If weren't connected, we wait for 10 seconds and try again</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-79"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">"Failed, rc="</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-80"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">state</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-81"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Serial</span><span class="crayon-sy">.</span><span class="crayon-e">println</span><span class="crayon-sy">(</span><span class="crayon-s">" try again in 10 seconds"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-82"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">delay</span><span class="crayon-sy">(</span><span class="crayon-cn">10000</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-83"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-84"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// If connection is active, then sends the data to the server with the specified time interval</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-85"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-86"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-87"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">amp</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">gt</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e ">send_interval *</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-88"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">last_time</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">millis</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-89"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-e">read22</span><span class="crayon-sy">(</span><span class="crayon-v">DHT22_PIN</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">DHTLIB_OK</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-90"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">humidity</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-91"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/hum"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-92"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">dtostrf</span><span class="crayon-sy">(</span><span class="crayon-v">DHT</span><span class="crayon-sy">.</span><span class="crayon-v">temperature</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-93"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">publish</span><span class="crayon-sy">(</span><span class="crayon-s">"example2/temp"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-94"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-95"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-96"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-97"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Check of incoming connections on a subscription</span></div><div class="crayon-line crayon-striped-line" id="crayon-5cefa47a4599f767357027-98"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">client</span><span class="crayon-sy">.</span><span class="crayon-e">loop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5cefa47a4599f767357027-99"><span class="crayon-sy">}</span></div></div></td>
					</tr>
				</table>
			</div>
		</div>
<!-- [Format Time: 0.0167 seconds] -->
<p>The result of the work &#8211; <strong>mqtt.1</strong> driver objects:</p>
<p><a href="wp-content\uploads\12.png"><img class="alignnone size-large wp-image-6613" src="wp-content\uploads\12-1024x187.png" alt="" width="750" height="137" srcset="wp-content\uploads\12-1024x187.png 1024w, wp-content\uploads\12-150x27.png 150w, wp-content\uploads\12-300x55.png 300w, wp-content\uploads\12-100x18.png 100w, wp-content\uploads\12-200x37.png 200w, wp-content\uploads\12-450x82.png 450w, wp-content\uploads\12-600x110.png 600w, wp-content\uploads\12-900x165.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>Now let&#8217;s set up publish/subscribe data to the cloud. For a start, register on the site <a href="https://www.cloudmqtt.com/">cloudmqtt.com</a>, select the desired rate, create instance, get settings:</p>
<p><a href="wp-content\uploads\MQTT-example-cloud4.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud4.jpg" width="400" height="337"></a></p>
<p>For greater security it is better to create a separate user, assume that it will be user <strong>iobroker</strong>with the password <strong>1234</strong>. Give user permission to read and write in any topic:</p>
<p><a href="wp-content\uploads\MQTT-example-cloud5.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud5.jpg" width="401" height="154"></a></p>
<p>Next set the instance of the mqtt <strong>driver.0</strong> to connect as a client/subscriber cloud broker and a list of publications/subscriptions:</p>
<p><a href="wp-content\uploads\8.png"><img class="alignnone size-medium wp-image-6614" src="wp-content\uploads\8-283x300.png" alt="" width="283" height="300" srcset="wp-content\uploads\8-283x300.png 283w, wp-content\uploads\8-141x150.png 141w, wp-content\uploads\8-100x106.png 100w, wp-content\uploads\8-150x159.png 150w, wp-content\uploads\8-200x212.png 200w, wp-content\uploads\8-300x318.png 300w, wp-content\uploads\8-450x478.png 450w, wp-content\uploads\8-600x637.png 600w, wp-content\uploads\8.png 797w" sizes="(max-width: 283px) 100vw, 283px"></a></p>
<ul>
<li>connection type – the customer/subscriber,</li>
<li>connection settings – specify the URL issued in the control panel <a href="https://www.cloudmqtt.com/">cloudmqtt.com</a> the port will use <strong>22809</strong>that works with <strong>SSL</strong>,</li>
<li>in the authentication options specify the user name and password,</li>
<li>patterns – our client ioBroker will be signed on all the topics that are in the cloud, so you specify here the number sign (<strong>#</strong>), you can use a mask to selectively subscribe,</li>
<li>mask of the eigenvalues client will publish to the server <strong>temperature/humidity</strong> and the status of all ports megaD (ports with relay P7-P13),this field separated by a comma specify the required variables:<br>
<strong>mqtt.1.example2.hum,mqtt.1.example2.temp,megad.0.p7_P7,megad.0.p8_P8,megad.0.p9_P9,megad.0.p10_P10,megad.0.p11_P11,megad.0.p12_P12,megad.0.p13_P13</strong>,</li>
<li>to send only changes – put a tick, will publish only the changes,</li>
<li>to give your own values at the start – just specify to create topics,</li>
<li>to send not only commands, but also the state (ack=true) – it should be noted that setting both the temperature/humidity updated driver mqtt (ack=true).</li>
</ul>
<p>Settings saved, make sure that the connection is established (on the control panel <a href="https://www.cloudmqtt.com/">cloudmqtt.com</a> watch the log server). After some time, data will appear (in the panel link <strong>WebsocketUI</strong>):</p>
<p><a href="wp-content\uploads\MQTT-example-cloud7.jpg"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud7.jpg" width="400" height="377"></a></p>
<p>In the end, it remains only to configure a mobile client, for example <a href="https://play.google.com/store/apps/details?id=com.thn.iotmqttdashboard&hl=en">IoT MQTT Dashboard</a>. Create a new connection:</p>
<p><a href="wp-content\uploads\MQTT-example-cloud8.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud8.png" width="302" height="515"></a></p>
<p>Create topics for publication (for example, lighting of the hall &#8211; port <strong>P7</strong> MegaD):</p>
<p><a href="wp-content\uploads\MQTT-example-cloud9.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud9.png" width="300" height="512"></a></p>
<p>then create subscription for the topics (temperature, humidity, hall light on port <strong>P7</strong> MegaD):</p>
<p><a href="wp-content\uploads\MQTT-example-cloud10.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud10.png" width="250" height="427"> </a><a href="wp-content\uploads\MQTT-example-cloud11.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud11.png" width="250" height="427"> </a><a href="wp-content\uploads\MQTT-example-cloud12.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud12.png" width="250" height="427"></a></p>
<p>In the end, your dashboard might look something like this:</p>
<p><a href="wp-content\uploads\MQTT-example-cloud13.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud13.png" width="250" height="427"> </a><a href="wp-content\uploads\MQTT-example-cloud14.png"><img class="alignnone" src="wp-content\uploads\MQTT-example-cloud14.png" width="250" height="427"></a></p>
<p>After the creation of the publications on a mobile device, in the driver instance <strong>mqtt.0</strong> system ioBroker should appear variable light control that should be used in the script for lighting control (see <a href="index-88.htm?page_id=6435&amp;lang=en#Application_8211_connecting_mobile_clients">example above</a>):</p>
<p><a href="wp-content\uploads\mqtt_13.png"><img class="alignnone size-large wp-image-6615" src="wp-content\uploads\mqtt_13-1024x230.png" alt="" width="750" height="168" srcset="wp-content\uploads\mqtt_13-1024x230.png 1024w, wp-content\uploads\mqtt_13-150x34.png 150w, wp-content\uploads\mqtt_13-300x67.png 300w, wp-content\uploads\mqtt_13-100x22.png 100w, wp-content\uploads\mqtt_13-200x45.png 200w, wp-content\uploads\mqtt_13-450x101.png 450w, wp-content\uploads\mqtt_13-600x135.png 600w, wp-content\uploads\mqtt_13-900x202.png 900w" sizes="(max-width: 750px) 100vw, 750px"></a></p>
<p>Congratulations! Now you can control the system ioBroker and receive data via a cloud service!</p>
				
<footer class="post-data">
	
	<div class="entry-meta">
			</div><!-- .entry-meta -->
	</footer><!-- .post-data -->
			</div><!-- .post-entry -->
	</article><!-- #post-## -->

				
			
		</main><!-- #main -->

			<div id="widgets" class="widget-area right-sidebar" role="complementary" itemscope="itemscope" itemtype="http://schema.org/WPSideBar">
		
		<div id="text-18" class="widget-wrapper widget_text">			<div class="textwidget"><div class="adaptermenueclass">
<!-- Page-list plugin v.5.1 wordpress.org/plugins/page-list/ -->
<ul class="page-list ">
<li class="page_item page-item-5038 page_item_has_children"><a href="index-92.htm?page_id=5038&lang=en">Adapter category VIS</a>
<ul class='children'>
	<li class="page_item page-item-5029"><a href="index-301.htm?page_id=5029&lang=en">ioBroker.vis App</a></li>
	<li class="page_item page-item-6903"><a href="index-398.htm?page_id=6903&lang=en">Widgets ioBroker.vis-players</a></li>
</ul>
</li>
<li class="page_item page-item-4541 page_item_has_children"><a href="index-75.htm?page_id=4541&lang=en">Common</a>
<ul class='children'>
	<li class="page_item page-item-4179"><a href="index-76.htm?page_id=4179&lang=en">Driver Admin</a></li>
</ul>
</li>
<li class="page_item page-item-5298 page_item_has_children current_page_ancestor current_page_parent"><a href="index-86.htm?page_id=5298&lang=en">Communication</a>
<ul class='children'>
	<li class="page_item page-item-6435 current_page_item"><a href="index-88.htm?page_id=6435&lang=en">Adapter MQTT</a></li>
	<li class="page_item page-item-5289"><a href="index-84.htm?page_id=5289&lang=en">Adapter Pushsafer</a></li>
	<li class="page_item page-item-6624"><a href="index-87.htm?page_id=6624&lang=en">Adapter Telegram</a></li>
	<li class="page_item page-item-6796"><a href="index-397.htm?page_id=6796&lang=en">eMail</a></li>
</ul>
</li>
<li class="page_item page-item-2578 page_item_has_children"><a href="index-89.htm?page_id=2578&lang=en">Hardware</a>
<ul class='children'>
	<li class="page_item page-item-4188"><a href="index-91.htm?page_id=4188&lang=en">RFLink</a></li>
	<li class="page_item page-item-2575"><a href="index-90.htm?page_id=2575&lang=en">Siemens SIMATIC S7</a></li>
</ul>
</li>
<li class="page_item page-item-4787 page_item_has_children"><a href="index-77.htm?page_id=4787&lang=en">Media</a>
<ul class='children'>
	<li class="page_item page-item-4713"><a href="index-78.htm?page_id=4713&lang=en">Adapter sayIt</a></li>
</ul>
</li>
<li class="page_item page-item-4784 page_item_has_children"><a href="index-79.htm?page_id=4784&lang=en">Scripts and logic</a>
<ul class='children'>
	<li class="page_item page-item-4711"><a href="index-80.htm?page_id=4711&lang=en">Adapter text2command</a></li>
	<li class="page_item page-item-5809"><a href="index-81.htm?page_id=5809&lang=en">Javascript</a></li>
</ul>
</li>
<li class="page_item page-item-4538 page_item_has_children"><a href="index-82.htm?page_id=4538&lang=en">Storage</a>
<ul class='children'>
	<li class="page_item page-item-4531"><a href="index-83.htm?page_id=4531&lang=en">Adapter History</a></li>
	<li class="page_item page-item-4184"><a href="index-85.htm?page_id=4184&lang=en">Adapter SQL</a></li>
</ul>
</li>
<li class="page_item page-item-5823 page_item_has_children"><a href="index-93.htm?page_id=5823&lang=en">Visualisation</a>
<ul class='children'>
	<li class="page_item page-item-5816"><a href="index-94.htm?page_id=5816&lang=en">Adapter Flot</a></li>
</ul>
</li>

</ul></div></div>
		</div>
			</div><!-- end of #widgets -->
	</div><!-- #content -->

</div><!-- end of #wrapper -->
</div><!-- end of #container -->


<footer id="footer" class="site-footer" role="contentinfo" itemscope="itemscope" itemtype="http://schema.org/WPFooter">
		<div id="footer-wrapper">

		<div id="footer-widgets-container">
					</div><!-- #footer-widgets-container-->

		<div id="menu-social-container">
			<nav id="footer-menu-container">
				<ul id="menu-2016_seitenfuss_en" class="footer-menu"><li id="menu-item-2219" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2219"><a href="index-106.htm?page_id=2216&#038;lang=en">Contact</a></li>
<li id="menu-item-2533" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2533"><a href="index-107.htm?page_id=2528&#038;lang=en">Imprint</a></li>
<li id="menu-item-2534" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2534"><a href="index-108.htm?page_id=2525&#038;lang=en">Privacy policy</a></li>
<li id="menu-item-2535" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2535"><a href="index-109.htm?page_id=2523&#038;lang=en">Sitemap (EN)</a></li>
<li id="menu-item-2532" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2532"><a href="index-110.htm?page_id=2530&#038;lang=en">THX</a></li>
</ul>			</nav><!-- #footer-menu -->
			<div id="social-icons-container">
				<ul class="social-icons"></ul><!-- .social-icons -->			</div><!-- #social-icons-container-->
		</div><!-- #menu-social-container -->

		
		<div id="footer-base">
			<div class="copyright">
				&copy; 2019 <a href="index-1.htm?lang=en" title="ioBroker">ioBroker</a>			</div><!-- .copyright -->

			<div class="powered">
				<a href="http://cyberchimps.com/responsive-II/">Responsive II</a> powered by <a href="http://wordpress.org/">WordPress</a>			</div><!-- end .powered -->

			<div class="scroll-top">
				<a href="#scroll-top" title="scroll to top">&uarr;</a>
			</div><!-- .scroll-top -->
		</div><!-- #footer-base -->
	</div><!-- #footer-wrapper -->
	</footer><!-- #footer -->
<div id="cookie-law-info-bar"><span>This website uses cookies to improve your experience. We'll assume you're ok with this, but you can opt-out if you wish.<a data-cli_action="accept" id="cookie_action_close_header" class="medium cli-plugin-button cli-plugin-main-button cookie_action_close_header cli_action_button" style="display:inline-block; ">Akzeptieren</a> <a href='..\index-1.htm?page_id=2305&#038;lang=de' id="CONSTANT_OPEN_URL" target="_blank" class="cli-plugin-main-link" style="display:inline-block;">mehr Infos</a></span></div><div id="cookie-law-info-again" style="display:none;"><span id="cookie_hdr_showagain">Privacy & Cookies Policy</span></div><div class="cli-modal-backdrop cli-fade cli-settings-overlay"></div>
<div class="cli-modal-backdrop cli-fade cli-popupbar-overlay"></div>
<script type="text/javascript">
  /* <![CDATA[ */
  cli_cookiebar_settings='{"animate_speed_hide":"500","animate_speed_show":"500","background":"#fff","border":"#444","border_on":false,"button_1_button_colour":"#000","button_1_button_hover":"#000000","button_1_link_colour":"#fff","button_1_as_button":true,"button_1_new_win":false,"button_2_button_colour":"#333","button_2_button_hover":"#292929","button_2_link_colour":"#444","button_2_as_button":false,"button_2_hidebar":true,"button_3_button_colour":"#000","button_3_button_hover":"#000000","button_3_link_colour":"#fff","button_3_as_button":true,"button_3_new_win":false,"button_4_button_colour":"#000","button_4_button_hover":"#000000","button_4_link_colour":"#fff","button_4_as_button":true,"font_family":"inherit","header_fix":false,"notify_animate_hide":true,"notify_animate_show":false,"notify_div_id":"#cookie-law-info-bar","notify_position_horizontal":"right","notify_position_vertical":"bottom","scroll_close":false,"scroll_close_reload":false,"accept_close_reload":false,"reject_close_reload":false,"showagain_tab":false,"showagain_background":"#fff","showagain_border":"#000","showagain_div_id":"#cookie-law-info-again","showagain_x_position":"100px","text":"#000","show_once_yn":false,"show_once":"10000","logging_on":false,"as_popup":false,"popup_overlay":true,"bar_heading_text":"","cookie_bar_as":"banner","popup_showagain_position":"bottom-right","widget_position":"left"}';
  /* ]]> */
</script><div class="scroll-back-to-top-wrapper">
	<span class="scroll-back-to-top-inner">
					<i class="fa fa-2x fa-arrow-circle-up"></i>
			</span>
</div><script type='text/javascript'>
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"http:\/\/www.iobroker.net\/docu\/?rest_route=\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}}};
var wpcf7 = {"apiSettings":{"root":"http:\/\/www.iobroker.net\/docu\/?rest_route=\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}}};
/* ]]> */
</script>
<script type='text/javascript' src='wp-content\plugins\contact-form-7\includes\js\scripts.js?ver=4.9.2'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var scrollBackToTop = {"scrollDuration":"500","fadeDuration":"0.5"};
var scrollBackToTop = {"scrollDuration":"500","fadeDuration":"0.5"};
/* ]]> */
</script>
<script type='text/javascript' src='wp-content\plugins\scroll-back-to-top\assets\js\scroll-back-to-top.js'></script>
<script type='text/javascript' src='wp-content\plugins\table-of-contents-plus\front.min.js?ver=1509'></script>
<script type='text/javascript' src='wp-content\themes\responsive-mobile\js\responsive-scripts.min.js?ver=1.2.5'></script>
<script type='text/javascript' src='wp-includes\js\wp-embed.min.js?ver=4.7.5'></script>
</body>
</html>
